'use strict';define(["jquery","modules/default/defaultview","src/util/debug","lodash","slickgrid","src/util/util","src/util/ui","src/util/color","src/util/api","src/util/typerenderer","src/util/sandbox","./copyFormatters"],function(a,b,c,d,f,g,h,e,j,k,l,m){"use strict";function n(){}function o(a){return!a.colDef}function p(b){b.$container.html(""),b.ignoreMyHighlights=b.module.getConfigurationCheckbox("slickCheck","ignoreMyHighlights");var e=b.getAllSlickColumns().filter(u),g=d.map(e,"id");for(var h in b.columnFilters)-1===g.indexOf(h)&&delete b.columnFilters[h];if(b.hiddenColumns||(b.hiddenColumns=e.map(function(a){if(a.colDef&&a.colDef.hideColumn&&"yes"===a.colDef.hideColumn[0])return a.name}).filter(function(a){return a})),b.slick.columns=b.getInMainColumns(),b.$rowToolbar=a("<div>").attr("class","rowToolbar"),b.module.getConfigurationCheckbox("toolbar","add")&&(b.$addButton=a("<input type=\"button\" value=\"New\"/>"),b.$addButton.on("click",function(){var a=b.grid.getColumns(),c=d.findIndex(a,function(a){return a.editor});-1<c&&(b.preventRowHelp(),b.grid.gotoCell(b.slick.data.getLength(),c,!0)),b._openDetails()}),b.$rowToolbar.append(b.$addButton)),b.module.getConfigurationCheckbox("toolbar","update")&&(b.$updateButton=a("<input type=\"button\" value=\"Update\"/>"),b.$updateButton.on("click",function(){b._openDetails()}),b.$rowToolbar.append(b.$updateButton)),b.module.getConfigurationCheckbox("toolbar","remove")&&(b.$deleteButton=a("<input type=\"button\" value=\"Delete\"/>"),b.$deleteButton.on("click",function(){b.deleteRowSelection()}),b.$rowToolbar.append(b.$deleteButton)),b.module.getConfigurationCheckbox("toolbar","showHide")){b.$showHideSelection=a.tmpl("<input type=\"button\" value=\"Show/Hide Column\"/>\n    <div class=\"mutliSelect\" style=\"display:none\">\n        <ul>\n            {{each columns}}\n            \n            <li><input type=\"checkbox\" value=\"${name}\" checked/>${name}</li>\n            {{/each}}\n        </ul>\n    </div>",{columns:e}),b.columnSelectionShown&&b.$showHideSelection.filter("div").show(),b.$showHideSelection.on("click",function(){b.$showHideSelection.filter("div").toggle(),b.columnSelectionShown=b.$showHideSelection.filter("div").is(":visible"),b.onResize()});for(var j=0;j<b.hiddenColumns.length;j++)b.$showHideSelection.find(`input[value="${b.hiddenColumns[j]}"]`).removeAttr("checked");b.$showHideSelection.find("input[type=\"checkbox\"]").on("change",function(){return this.checked?b.hideColumn(this.value):b.showColumn(this.value),p(b)}),b.$rowToolbar.append(b.$showHideSelection)}b.$actionButtons=Array(b.actionOutButtons.length);for(var j=0;j<b.actionOutButtons.length;j++)(function(c){b.$actionButtons[c]=a(`<input type="button" value="${b.actionOutButtons[c].buttonTitle}"/>`),b.$actionButtons[c].on("click",function(){b.module.controller.sendActionButton(b.actionOutButtons[c].actionName,b._getSelectedItems())})})(j);b.$rowToolbar.append(b.$actionButtons),b.$container.append(b.$rowToolbar),b.module.getConfiguration("toolbar")&&0===b.module.getConfiguration("toolbar").length&&b.$actionButtons&&0===b.$actionButtons.length&&b.$rowToolbar&&b.$rowToolbar.remove(),b.$slickgrid=a("<div>").addClass("flex-1").addClass("visualizer-slickgrid"),b.$container.append(b.$slickgrid),b.slick.groupItemMetadataProvider=new f.Data.GroupItemMetadataProvider,b.slick.plugins.push(b.slick.groupItemMetadataProvider),b.slick.data=new f.Data.DataView({groupItemMetadataProvider:b.slick.groupItemMetadataProvider}),b.slick.data.setModule(b.module),b.grid=new f.Grid(b.$slickgrid,b.slick.data,b.slick.columns,b.slick.options),b.slick.grid=b.grid,b._newSandbox();for(var j=0;j<b.slick.plugins.length;j++)b.grid.registerPlugin(b.slick.plugins[j]);if("row"===b.module.getConfiguration("slick.selectionModel")?b.grid.setSelectionModel(new f.RowSelectionModel):b.grid.setSelectionModel(new f.CellSelectionModel),b.module.getConfigurationCheckbox("copyPaste","active")&&b.grid.registerPlugin(new f.CellExternalCopyManager({noAutoFocus:b.module.getConfigurationCheckbox("copyPasteOptions","noAutoFocus"),readOnlyMode:b.module.getConfigurationCheckbox("copyPasteOptions","readOnly"),newRowCreator:function(a){if(b.module.getConfigurationCheckbox("copyPasteOptions","newRows")){const c=[];for(let b=0;b<a;b++)c.push({});b.onActionReceive.addRow.call(b,c)}},dataItemColumnValueExtractor:function(c,d){const e=m[d.colDef.copyFormatter];if(e)return e.extract(c,d);if(d.CpEditor){var f={container:a("<p>"),column:d,position:{top:0,left:0},grid:b.grid},g=new d.CpEditor(f);g.loadValue(c);var h=g.serializeValue();return g.destroy(),h}}})),b.module.getConfigurationCheckbox("autoColumns","reorder")){var k=new f.RowMoveManager({cancelEditOnDrag:!0});k.onBeforeMoveRows.subscribe(function(a,b){for(var c=0;c<b.rows.length;c++)if(b.rows[c]==b.insertBefore||b.rows[c]==b.insertBefore-1)return a.stopPropagation(),!1;return!0}),k.onMoveRows.subscribe(function(a,c){var d=c.rows;d=d.map(function(a){return b._getItemInfoFromRow(a).idx});var e=b._getItemInfoFromRow(c.insertBefore);null!==e&&(e=e.idx),b._makeDataObjects();for(var f=b.slick.data.getItems(),g=0;g<f.length;g++)f[g].__pos=-1===d.indexOf(g)?g<e||null===e?1:3:2;b.slick.data.sort(v);for(var g=0;g<f.length;g++)delete f[g].__pos;b.grid.invalidateAllRows(),b.grid.render(),b.module.model.dataTriggerChange(b.module.data)}),b.grid.registerPlugin(k),b.grid.onDragInit.subscribe(function(a){a.stopImmediatePropagation()}),b.grid.onDragStart.subscribe(function(c,d){var e=this.module.data.get(),g=b.grid.getCellFromEvent(c);if(g&&(d.row=g.row,!!e[d.row])&&!f.GlobalEditorLock.isActive()){c.stopImmediatePropagation(),d.mode="recycle";var h=b.grid.getSelectedRows();h.length&&-1!=a.inArray(d.row,h)||(h=[d.row],b.grid.setSelectedRows(h)),d.rows=h,d.count=h.length;var i=a("<span></span>").css({position:"absolute",display:"inline-block",padding:"4px 10px",background:"#e0e0e0",border:"1px solid gray","z-index":99999,"-moz-border-radius":"8px","-moz-box-shadow":"2px 2px 6px silver"}).appendTo("body");return d.helper=i,a(d.available).css("background","pink"),i}}),b.grid.onDrag.subscribe(function(a,b){"recycle"!=b.mode||b.helper.css({top:a.pageY+5,left:a.pageX+5})}),b.grid.onDragEnd.subscribe(function(b,c){"recycle"!=c.mode||(c.helper.remove(),a(c.available).css("background","beige"))})}a(b.grid.getHeaderRow()).delegate(":input","change keyup",d.debounce(function(){var c=a(this).data("columnId");null!=c&&(b.columnFilters[c]=a.trim(a(this).val()),b.columnFilterFunctions[c]=t(b.columnFilters[c]),b.slick.data.refresh())},250)),b.grid.onHeaderRowCellRendered.subscribe(function(c,d){a(d.node).empty(),a("<input type='text'>").css("width","100%").data("columnId",d.column.id).val(b.columnFilters[d.column.id]).appendTo(d.node)}),b.grid.init(),b._activateHighlights(),b.grid.module=b.module,b.slick.data.syncGridSelection(b.grid,!0),b.module.getConfigurationCheckbox("slickCheck","oneUncollapsed")&&b.slick.groupItemMetadataProvider.onGroupExpanded.subscribe(function(a,b){this.getData().collapseAllGroups(b.item.level),this.getData().expandGroup(b.item.groupingKey)}),b.slick.data.onRowCountChanged.subscribe(function(){b.grid.updateRowCount(),b.grid.render()}),b.slick.data.onRowsChanged.subscribe(function(a,c){if(b.hasFilter){var d=b._getItemsInfo(c.rows);b._runFilter({event:"rowsChanged",rows:d})}b.grid.invalidateRows(c.rows),b.grid.render()}),b.grid.onAddNewRow.subscribe(function(a,c){const d=c.item;b.setNextUniqId(d,!0),b.slick.data.addItem(d),b._newRow(d,c)}),b.grid.onRenderCompleted.subscribe(function(){b._jpathColor()}),b.grid.onViewportChanged.subscribe(function(){function a(){if(b.lastViewport=b.grid.getViewport(),b.module.getConfigurationCheckbox("slickCheck","rowNumbering")&&!b._preventRowHelp){var a=b.grid.getDataLength();b.$rowHelp.html(`${Math.min(a,b.lastViewport.bottom-(b.addRowAllowed?2:1)).toString()}/${a}`),b.$rowHelp.fadeIn(),clearTimeout(b.lastRowHelp),b.lastRowHelp=setTimeout(function(){b.$rowHelp.fadeOut()},1e3)}b._preventRowHelp=!1,b._jpathColor(),b._inViewFilter()}setTimeout(function(){var c=b.grid.getViewport();c!==b.lastViewport&&a()},250),a()}),b.grid.onMouseEnter.subscribe(function(a){b._hl&&b.module.model.highlightId(b._hl,0),b.count=void 0===b.count?0:b.count,b.count++,b.hovering=!0;var c=b._getItemInfoFromEvent(a);if(c){var d=c.item._highlight;b._hl=d,d&&(b.module.model.highlightId(d,1),C=d),b.module.controller.onHover(c.idx,c.item)}}),b.grid.onMouseLeave.subscribe(function(a){b._e=a,b.count--,b.hovering=!1;var c=b._getItemInfoFromEvent(a);if(c){var d=c.item._highlight;d?b.module.model.highlightId(d,0):C&&b.module.model.highlightId(C,0)}}),b.grid.onColumnsResized.subscribe(function(){var a=b.grid.getColumns();for(let d=0;d<a.length;d++){var c=b.colConfig.find(function(b){return b===a[d].colDef});c&&(c.width=a[d].width)}b.grid.invalidate()}),b.grid.onCellChange.subscribe(function(a,c){if(b.fromPopup)var d=b.getColumnsGivenEditContext();else var e=b._getChangedColumn(c.cell);if(!o(e)){var f=b._getItemInfoFromRow(c.row);if(f){if(b.hasFilter){if(d)for(var g=0;g<d.length;g++)b._runFilter({event:"cellChanged",row:f,cell:b._getCell({row:c.row,cell:g}),previous:c.previous,column:d[g]});else b._runFilter({event:"cellChanged",row:f,cell:b._getCell(c),column:e,previous:c.previous});b._runFilter({event:"rowsChanged",rows:[f]})}b.module.controller.onRowChange(f.idx,f.item)}}}),b.grid.onClick.subscribe(function(a,c){var d=b.grid.getColumns(),e=b._getItemInfoFromRow(c.row);e&&d[c.cell]&&"rowDeletion"!==d[c.cell].id&&(!d[c.cell].colDef||!d[c.cell].colDef.isAction)&&b.module.controller.onClick(e.idx,e.item)}),b.grid.onDblClick.subscribe(function(a,c){var d=b._getItemInfoFromRow(c.row);b.module.controller.onDoubleClick(d.idx,d.item)}),b.grid.onActiveCellChanged.subscribe(function(a,c){b.lastActiveCell=c.cell,b.lastActiveRow=c.row;var d=b._getItemInfoFromRow(c.row);if(d){var e=b.grid.getColumns();e[c.cell]&&"rowDeletion"!==e[c.cell].id&&b.module.controller.onActive(d.idx,d.item)}}),b.grid.onColumnsReordered.subscribe(function(){var a=b.grid.getColumns(),e=b.module.definition.configuration.groups.cols[0],f=d.map(e,"name"),g=d.map(a,"id");if(f.concat().sort().join()!==g.concat().sort().join())return void c.warn("Something might be wrong, number of columns in grid and in configuration do not match");b.module.definition.configuration.groups.cols[0]=[];for(var h,j=0;j<a.length;j++)h=f.indexOf(g[j]),-1<h&&b.module.definition.configuration.groups.cols[0].push(e[h])}),b.grid.onSelectedRowsChanged.subscribe(function(a,c){b.lastSelectedRows=c.rows.slice();var e=b._getItemsInfo(b.lastSelectedRows);if(b.hasFilter&&b._runFilter({event:"rowsSelected",rows:e}),e.length){const a=e[b.lastSelectedRows.length-1];b.module.controller.onLastSelectedRow(a.idx,a.item)}else b.module.controller.unselectLastRow();b.module.controller.onRowsSelected(d.map(e,"item"))}),b.grid.onSort.subscribe(function(a,c){b._makeDataObjects();var d=c.sortCols?c.sortCols:[{sortCol:c.sortCol,sortAsc:c.sortAsc}];for(let f=d.length-1;0<=f;f--){var e=function(a,b){return void 0===a?d[f].sortAsc?1:-1:void 0===b?d[f].sortAsc?-1:1:a<b?-1:b<a?1:0};let a=d[f],c=a.sortCol.jpath;b.slick.data.sort(e,a.sortAsc,function(a){var b=a.getChildSync(c);return void 0!==b&&(b=b.get()),b})}b._updateHighlights(),b.grid.invalidateAllRows(),b.grid.render(),b.module.model.dataTriggerChange(this.module.data)}),b.slick.data.beginUpdate();var l=d.chain(b.module.getConfiguration("groupings")).filter(a=>a&&a.groupName&&a.getter).map(a=>{var c={};return a.getter&&1<a.getter.length?(c.getter=function(b){return b.getChildSync(a.getter)},b._makeDataObjects()):c.getter=a.getter[0],c.formatter=function(b){return`${a.groupName}: ${b.value}  <span style='color:green'>(${b.count} items)</span>`},c.aggregateCollapsed=!1,c.lazyTotalsCalculation=!0,c}).value();l.length&&(b.slick.data.setGrouping(l),b.module.getConfigurationCheckbox("slickCheck","collapseGroup")&&b.slick.data.collapseAllGroups(0)),b.module.getConfigurationCheckbox("slickCheck","filterColumns")&&b.searchFilter&&b.slick.data.setFilter(b.searchFilter),b.slick.data.setItems(b.module.data.get(),b.idPropertyName),b.slick.data.endUpdate(),b.lastViewport&&!b.module.getConfigurationCheckbox("slickCheck","backToTop")&&b.grid.scrollRowToTop(b.lastViewport.top),!b.module.getConfigurationCheckbox("slickCheck","forgetLastSelected")&&Array.isArray(b.lastSelectedRows)&&b.grid.setSelectedRows(b.lastSelectedRows),d.isUndefined(b.lastActiveRow)||b.module.getConfigurationCheckbox("slickCheck","forgetLastActive")||b.grid.gotoCell(b.lastActiveRow,b.lastActiveCell,!1,!0),b.grid.render(),b._setBaseCellCssStyle(),b.lastViewport=b.grid.getViewport(),b._jpathColor(),b._inViewFilter()}function q(){return"..."}function r(){return"<div style=\"width:100%; height: 100%;\"><a class=\"icon-clickable recycle-bin\"><i class=\"centered-icon fa fa-trash\"></i></a></div>"}function s(a,b,c,d){if(!c.__group&&(this.module.data.traceSync([b]),a)){var e=d.rendererOptions||{};d.renderType&&(e.forceType=d.renderType),k.render(a,c,d.jpath,e),this.postRenderer(a,b,c,d)}}function t(a){var b;if(b=a.match(/^"(.*)"$/),b)return function(a){return b=b.toLowerCase(),a=(a+"").toLowerCase(),a.match(b[1])};if(b=a.match(/^\/(.+)\/(i?)/),b)return function(a){return(a+"").match(new RegExp(b[1],b[2]||void 0))};if(b=a.match(/^([<>=]{1,2})([0-9]+)-([0-9\-:]*)$/),b){b=a.match(/^([<>=]{0,2})([0-9]+)-([0-9]*)-?([0-9]*)/);let c=parseInt(b[2],10),d=parseInt(b[3],10),e=parseInt(b[4],10);Number.isNaN(d)&&(d=1),Number.isNaN(e)&&(e=1);const f=new Date;if(f.setUTCFullYear(c),f.setUTCMonth(d-1),f.setUTCDate(e),f.setUTCHours(0),f.setUTCMinutes(0),f.setUTCSeconds(0),f.setUTCMilliseconds(0),"<"===b[1])return function(a){const b=new Date(a);return b<f};if(">"===b[1])return function(a){const b=new Date(a);return b>f};if("<="===b[1])return function(a){const b=new Date(a);return b<=f};if(">="===b[1])return function(a){const b=new Date(a);return b>=f};throw new Error("Invalid date operator")}if(b=a.match(/^([<>=]{1,2})([0-9.-]+)$/),b){if("<"===b[1])return function(a){return a<b[2]};if("<="===b[1]||"=<"===b[1])return function(a){return a<=b[2]};if(">"===b[1])return function(a){return a>b[2]};if(">="===b[1]||"=>"===b[1])return function(a){return a>=b[2]};if("=="===b[1]||"="===b[1])return function(a){return a==b[2]}}return b=a.match(/^([0-9.-]+)\.\.([0-9.-]*)$/),b?function(a){return a>=b[1]&&a<=b[2]}:function(b){return(b+"").toLowerCase().match(a.toLowerCase())}}function u(a){return"rowDeletion"!==a.id&&"_checkbox_selector"!==a.id&&"__selectAndMove"!==a.id}function v(c,a){return c.__pos-a.__pos}var w=Symbol("_sgid"),x=[];x.push(g.loadCss("components/slickgrid/slick.grid.css"));var y=Promise.all(x),z=0,A={typerenderer:q,"slick.text":f.Formatters.Text,"slick.percent":f.Formatters.PercentComplete,"slick.percentbar":f.Formatters.PercentCompleteBar,"slick.yesno":f.Formatters.YesNoSelect};const B=f.typeEditors;a.extend(!0,n.prototype,b,{init:async function(){var b,c=this;if(this.columnFilters={},this.columnFilterFunctions={},this.searchFilter=void 0,this._setScript(""),this.title=this.module.definition.title+"",this.$container?this.$container.html(""):(this._id=g.getNextUniqueId(),this.$rowHelp=a("<div>").attr("class","rowHelp"),this.$container=a("<div>").attr("id",this._id).addClass("main-container"),this.module.getDomContent().html(this.$rowHelp),this.module.getDomContent().append(this.$container),this._setDeleteRowListener()),b=this.module.getConfigurationCheckbox("saveInView","yes")?this.module.getConfiguration("varname"):void 0,this.actionOutButtons=this.module.getConfiguration("actionOutButtons"),this.actionOutButtons=this.actionOutButtons||[],this.actionOutButtons=d.filter(this.actionOutButtons,a=>a.actionName&&a.buttonTitle),this.$container.on("mouseleave",function(){c.module.controller.lastHoveredItemId=null}),this.hiddenColumns=void 0,this.slick={},this.colConfig=this.module.getConfiguration("cols",[],!1).filter(function(a){return a.name}),this.actionColConfig=(this.module.getConfiguration("actionCols")||[]).filter(function(a){return a.name}).map(function(a){return a.isAction=!0,a}),this.idPropertyName=this.module.getConfiguration("idProperty")||w,this.autoIdProperty=!this.module.getConfiguration("idProperty"),"pref"===this.module.getConfiguration("filterType")&&this._setScript(this.module.getConfiguration("filterRow")),this.postRenderer=function(a,b,d,e){if(a){let b={event:"postRender",column:e,row:{item:d},renderOptions:{}};c._runFilter(b),c.postUpdateCell(a,b.renderOptions)}},this.actionRenderer=function(b,d,f,g){function h(){j.doAction(i.renderOptions.action,f)}if(b){var i={event:"renderAction",column:g,row:{item:f},renderOptions:{icon:g.colDef.icon,disabled:!1,action:g.colDef.action,tooltip:g.colDef.tooltip,backgroundColor:e.array2rgba(g.colDef.backgroundColor),color:g.colDef.color,clickMode:g.colDef.clickMode}};c._runFilter(i),b.innerHTML=i.renderOptions.disabled?"":i.renderOptions.icon&&i.renderOptions.icon.startsWith("fa-")?`<div style="width:100%; height: 100%"><a style="display: block; text-align:center;"><i class="fa ${i.renderOptions.icon} centered-icon"></i></a></div>`:`<div style="width:100%; height: 100%"><a>${i.renderOptions.icon}</a></div>`;var k=a(b);c.postUpdateCell(b,i.renderOptions),k.css("cursor","default");var l=k.find("a");l.attr("title",i.renderOptions.tooltip),i.renderOptions.action&&("text"===i.renderOptions.clickMode?(l.addClass("icon-clickable"),l.length&&(l[0].onclick=h)):"background"===i.renderOptions.clickMode&&(k.css("cursor","pointer"),k.off("click.action"),k.on("click.action",h))),l.css("color",e.array2rgba(i.renderOptions.color))}},b){const a=await j.createData(b,JSON.parse(this.module.getConfiguration("data")));a.onChange(()=>{this.module.definition.configuration.groups.data[0].data[0]=JSON.stringify(a)}),c.resolveReady()}else c.resolveReady()},loadEditors:async function(){const a=this.getAllSlickColumns(),b=a.filter(a=>a.editor&&a.editor.load);await Promise.all(b.map(a=>a.editor.load()))},postUpdateCell:function(b,c){var d=a(b);d.css(c)},preventRowHelp:function(){this._preventRowHelp=!0},deleteRowSelection:function(){for(var a,b=this.grid.getSelectedRows(),c=this.module.data.get(),d=Array(b.length),e=0;e<b.length;e++)a=this._getItemInfoFromRow(b[e]),d[e]=a.idx;d=d.sort();var f=0,g=[];for(e=0;e<b.length;e++){var h=c.splice(d[e]-f++,1);h.length&&g.push(h[0])}this.lastSelectedRows=[],g.length&&(this._deleteFilter(g),this.module.controller.onRowsDelete(g),this.module.data.triggerChange())},getAllSlickColumns:function(){function a(a){var c;if(e.module.data&&e.module.data.length){var d=e.module.data.get(0).getChildSync(a);return c=d instanceof DataString?f.CustomEditors.TextValue:d instanceof DataNumber?f.CustomEditors.NumberValue:d instanceof DataBoolean?f.CustomEditors.BooleanValue:B[b(a)],c}}function b(a){var b,c=a.slice(0);c.unshift(0);var d=e.module.data.getChildSync(c);return DataObject.isDataObject(d)&&(b=d.type),b}var e=this,h=s.bind(this),j=this.colConfig.filter(function(a){return a.name}).map(function(d){var i,j,k;"auto"===d.editor&&e.module.data?(e.module.data.get().length?(i=d.forceType?B[d.forceType]:a(d.jpath),i=i||a(d.jpath),k=b(d.jpath)):(i=f.CustomEditors.DataString,c.warn("Slick grid: using editor based on type when the input variable is empty. Cannot determine type")),j=i):(i=B[d.editor],j=i||a(d.jpath),k=b(d.jpath));var l=g.evalOptions(d.rendererOptions);return{id:d.name,name:d.name,field:d.name,width:+d.width||void 0,minWidth:+d.minWidth||void 0,maxWidth:+d.maxWidth||void 0,resizable:!0,selectable:!0,focusable:!0,sortable:!0,defaultSortAsc:!0,editor:i,CpEditor:j,compositeEditor:i===f.CustomEditors.LongText?f.CustomEditors.SimpleLongText:void 0,formatter:A[d.formatter],asyncPostRender:"typerenderer"===d.formatter?h:e.postRenderer.bind(this),jpath:d.jpath,simpleJpath:1===d.jpath.length,dataType:k,renderType:d.forceType,colDef:d,editorOptions:d.editorOptions,rendererOptions:l}});if(j=d.filter(j,a=>a.name),d.isEmpty(j)){for(var k=[],l=e.module.data.get(),m=0;m<l.length;m++)k=d(k).push(d.keys(l[m])).flatten().uniq().value();j=d(k).filter(a=>"_"!==a[0]).map(c=>({id:c,name:c,field:c,resisable:!0,selectable:!0,focusable:!0,sortable:!1,editor:a([c]),CpEditor:a([c]),dataType:b([c]),jpath:[c],formatter:A.typerenderer,asyncPostRender:h,colDef:{id:c,jpath:[c]}})).value()}for(var n=this.getActionColumns(),m=0;m<n.length;m++)"begin"===n[m].colDef.position?j.unshift(n[m]):j.push(n[m]);if(this.module.getConfigurationCheckbox("autoColumns","remove")&&j.unshift({id:"rowDeletion",width:30,field:"rowDeletion",selectable:!1,resizable:!1,focusable:!1,sortable:!1,formatter:r}),this.module.getConfigurationCheckbox("autoColumns","select")){var o=new f.CheckboxSelectColumn({cssClass:"slick-cell-checkboxsel"});this.slick.plugins.push(o),j.unshift(o.getColumnDefinition())}return this.module.getConfigurationCheckbox("autoColumns","reorder")&&j.unshift({id:"__selectAndMove",name:"",width:40,behavior:"selectAndMove",selectable:!1,resizable:!1,cssClass:"cell-reorder dnd",formatter:function(){return""}}),j},getSlickColumns:function(){var a=this,b=this.getAllSlickColumns();return b.filter(function(b){return-1===a.hiddenColumns.indexOf(b.name)})},getInMainColumns:function(){return this.getSlickColumns().filter(function(a){return!!o(a)||!a.colDef.visibility||"main"===a.colDef.visibility||"both"===a.colDef.visibility})},getInPopupColumns:function(){return this.getAllSlickColumns().filter(function(a){return!o(a)&&("popup"===a.colDef.visibility||"both"===a.colDef.visibility)}).filter(function(a){return a.editor}).filter(u)},getActionColumns:function(){var a=this;return this.actionColConfig.map(b=>({id:b.name,name:b.name,width:+b.width||25,minWidth:+b.minWidth||25,maxWidth:+b.maxWidth||25,selectable:!1,resizable:!0,focusable:!1,sortable:!1,formatter:q,asyncPostRender:a.actionRenderer,colDef:b}))},getColumnsGivenEditContext:function(){return this.fromPopup?this.getInPopupColumns():this.getInMainColumns()},getSlickOptions:function(){var a=this;return{editable:a.module.getConfigurationCheckbox("slickCheck","editable"),enableAddRow:a.module.getConfigurationCheckbox("slickCheck","enableAddRow"),enableCellNavigation:a.module.getConfigurationCheckbox("slickCheck","editable"),autoEdit:a.module.getConfigurationCheckbox("slickCheck","autoEdit"),enableTextSelectionOnCells:!0,enableColumnReorder:!0,forceFitColumns:a.module.getConfigurationCheckbox("slickCheck","forceFitColumns"),multiColumnSort:!0,asyncEditorLoading:!0,asyncEditorLoadDelay:30,enableAsyncPostRender:!0,asyncPostRenderDelay:0,defaultColumnWidth:a.module.getConfiguration("slick.defaultColumnWidth")||80,dataItemColumnValueExtractor:function(a){return a},explicitInitialization:!0,rowHeight:a.module.getConfiguration("slick.rowHeight"),showHeaderRow:a.module.getConfigurationCheckbox("slickCheck","filterColumns"),headerRowHeight:+a.module.getConfiguration("slick.headerRowHeight")}},_openDetails:function(){var b=this;if(!this.grid.getEditorLock().isActive()||this.grid.getEditorLock().commitCurrentEdit()){var c=this.getInPopupColumns();if(0!==c.length){var d=a("<div class='item-details-form'></div>");d=a.tmpl("<div class='item-details-form'>\n    {{each columns}}\n    <div class='item-details-label'>\n        ${name}\n    </div>\n    <div class='item-details-editor-container' data-editorid='${id.replace(/[^a-zA-Z0-9_-]/g, \"_\")}'></div>\n    {{/each}}\n\n    <hr/>\n    <div class='item-details-form-buttons'>\n        <button data-action='save'>Save</button>\n        <button data-action='cancel'>Cancel</button>\n    </div>\n</div>",{context:this.grid.getDataItem(this.grid.getActiveCell().row),columns:c}).appendTo("body"),d.keydown(function(c){c.which==a.ui.keyCode.ENTER?(b.fromPopup=!0,b.grid.getEditController().commitCurrentEdit(),b.fromPopup=!1,c.stopPropagation(),c.preventDefault()):c.which==a.ui.keyCode.ESCAPE&&(b.fromPopup=!0,b.grid.getEditController().cancelCurrentEdit(),b.fromPopup=!1,c.stopPropagation(),c.preventDefault())}),d.find("[data-action=save]").click(function(){b.fromPopup=!0,b.grid.getEditController().commitCurrentEdit(),b.fromPopup=!1}),d.find("[data-action=cancel]").click(function(){b.fromPopup=!0,b.grid.getEditController().cancelCurrentEdit(),b.fromPopup=!1});var e=a.map(c,function(a){return d.find(`[data-editorid=${a.id.replace(/[^a-zA-Z0-9_-]/g,"_")}]`)}),g=new f.CompositeEditor(c,e,{destroy:function(){d.remove()}});this.grid.editActiveCell(g)||d.remove()}}},inDom:function(){},update:{script:function(a){"invar"===this.module.getConfiguration("filterType")&&(this._setScript(a.get()),this._runFilter({event:"scriptChanged"})),this.rerender()},data:function(a,b){this.update.list.call(this,a,b)},list:function(a){var b=this;this.module.controller.lastClickedItem=void 0,this.module.data=a,this._updateHighlights(),this.dataObjectsDone=!1,this.slick.plugins=[],this.slick.options=this.getSlickOptions(),this.generateUniqIds(),this.addRowAllowed=this.module.getConfigurationCheckbox("slickCheck","enableAddRow");var e=this.module.getConfigurationCheckbox("slickCheck","keepSelected");this.searchFilter=function(a){if(e){var f=b._getSelectedItems();if(f.find(c=>a[b.idPropertyName]===c[b.idPropertyName]))return!0}for(var g in b.columnFilters)if(g!==void 0&&""!==b.columnFilters[g])try{var h=b.slick.data.getIdxById(a[b.idPropertyName]),i=b.grid.getColumns()[b.grid.getColumnIndex(g)],c=d.clone(DataObject.resurrect(i.jpath));c.unshift(h);var j=b.module.data.getChildSync(c);if(j&&j.get&&(j=j.get()),!b.columnFilterFunctions[g](j))return!1}catch(a){return!0}return!0};for(let b of this.colConfig)m[b.copyFormatter]&&m[b.copyFormatter].load();Promise.all([y,this.loadEditors()]).then(function(){p(b)})}},blank:{list:function(){this.$container.html("")},script:function(){"invar"===this.module.getConfiguration("filterType")&&this._setScript("")}},_newRow:function(a,b){this.module.controller.onRowNew(this.slick.data.getLength()-1,a),this.module.model.dataTriggerChange(this.module.data),this._runFilter({row:{item:a},column:b?b.column:null,cell:null,event:"newRow"})},_setBaseCellCssStyle:function(){var a=this.grid.getColumns();this.baseCellCssStyle={};for(var b=0;b<a.length;b++)this.baseCellCssStyle[a[b].id]="highlighted-cell"},_setDeleteRowListener:function(){var a=this;this.$container.on("click","a.recycle-bin",function(b){var c=a.grid.getColumns(),d=a.grid.getCellFromEvent(b);if(a.lastViewport=a.grid.getViewport(),c[d.cell]&&"rowDeletion"===c[d.cell].id){var e=a._getItemInfoFromRow(d.row),f=a.module.data.get().splice(e.idx,1);f.length&&(a._deleteFilter(f),a.module.controller.onRowsDelete(f),a.module.data.triggerChange())}})},_getItemInfoFromEvent:function(a){var b=this,c=this.grid.getCellFromEvent(a);if(!c)return null;var d=b.slick.data.mapRowsToIds([c.row])[0];return d?{id:d,idx:b.slick.data.getIdxById(d),item:b.slick.data.getItemById(d)}:null},_getItemInfoFromRow:function(a){var b=this;if(d.isUndefined(a))return null;var c=b.slick.data.mapRowsToIds([a])[0];return c?{id:c,idx:b.slick.data.getIdxById(c),item:b.slick.data.getItemById(c)}:null},_jpathColor:function(){var b=this;if(b.lastViewport){var c=b.module.getConfiguration("colorjPath");if(c&&0<c.length){b._makeDataObjects();for(var d,e=b.lastViewport.top;e<=b.lastViewport.bottom;e++)if(d=b.grid.getDataItem(e),d&&!0!==d.__group){var f=d.getChildSync(c),g=b.grid.getCellNode(e,0);f?a(g).parent().css("background-color",f.get()).addClass("has-color"):a(g).parent().css("background-color","").removeClass("has-color")}}}},_setScript:function(a){this.filterScript=a||"",this.hasFilter=this._hasFilter(),this._newSandbox()},_newSandbox:function(){this._sandbox=new l,this._sandbox.setContext(this._getNewContext());try{this.filter=this._sandbox.run(`(function() {${this.filterScript}\n})`,`Slickgrid${this.module.getId()}`)}catch(a){this._reportError(a)}},_runFilter:function(a){if(this.hasFilter)try{this.filter.call(a)}catch(a){this._reportError(a)}},_getNewContext:function(){var a=this;return{getSlick:function(){return a.slick},getData:function(){return a.module.data&&a.module.data.get()},rerender:function(b){a.rerender(b)},API:j}},rerender:function(a){this.grid&&(a?this.grid.invalidateRows(a):this.grid.invalidateAllRows(),this.grid.render())},_reportError:function(a){var b="";a&&a.stack&&(b=a.message,a=a.stack);var d="Code executor error";this.title&&(d+=` (${this.title})`),b&&(d+=`: ${b}`),c.error(d),c.warn(a)},_inViewFilter:function(){var a=this;if(a.hasFilter&&a.lastViewport){var b=a._getRowsFromViewport(),c=a._getItemsInfo(b);a._runFilter({rows:c,cell:null,event:"inView"})}},_deleteFilter:function(a){this.hasFilter&&this._runFilter({event:"rowsDeleted",rows:a})},_selectHighlight:function(){if(!this.hovering){var a=this;if(this.module.getConfigurationCheckbox("slickCheck","highlightScroll")){var b=d.findIndex(this._highlights,function(b){return void 0!==b&&(b===a._highlighted[0]||b.indexOf&&-1<b.indexOf(a._highlighted[0]))});if(-1<b){this.lastViewport=this.grid.getViewport();var c=a.slick.data.getItemByIdx(b),e=a.slick.data.getRowById(c[a.idPropertyName]);if(void 0===e)return;(e<this.lastViewport.top||e>=this.lastViewport.bottom)&&this.grid.scrollRowToTop(e)}}}},_updateHighlights:function(){this._highlights=d.map(this.module.data.get(),"_highlight")},_drawHighlight:function(){var a=this;this.grid.removeCellCssStyles("highlight");var b={};this._selectHighlight(),this.lastViewport=this.grid.getViewport();for(let f=this.lastViewport.top;f<=this.lastViewport.bottom;f++){var c=this._getItemInfoFromRow(f);if(c){var e=c.item;d.some(a._highlighted,function(a){var b=e._highlight;return Array.isArray(b)||(b=[b]),-1<b.indexOf(a)})&&(b[f]=a.baseCellCssStyle)}}this.grid.setCellCssStyles("highlight",b)},_activateHighlights:function(){var a=this,b=d(this.module.data.get()).map("_highlight").flatten().filter(a=>!d.isUndefined(a)).value();a._highlighted=[],j.killHighlight(this.module.getId());for(var c=0;c<b.length;c++)(function(c){j.listenHighlight({_highlight:b[c]},function(b,c,e,f){a.ignoreMyHighlights&&f===a.module.getId()||(!Array.isArray(c)&&(c=[c]),a._highlighted=b?d(a._highlighted).push(c).flatten().uniq().value():d.filter(a._highlighted,function(a){return-1===c.indexOf(a)}),a._drawHighlight())},!1,a.module.getId())})(c)},_makeDataObjects:function(){if(!this.dataObjectsDone){for(var a=this.module.data.get(),b=0;b<a.length;b++)a[b]=DataObject.check(a[b]);this.dataObjectsDone=!0}},_getRowsFromViewport:function(){if(!this.lastViewport)return[];var a=this.lastViewport.bottom-this.lastViewport.top+1;if(Number.isNaN(a)||0>a)return[];for(var b=Array(a),c=0;c<b.length;c++)b[c]=this.lastViewport.top+c;return b.filter(function(a){return 0<=a})},_getItemsInfo:function(a){var b=[];if(!this.slick.data)return b;for(var c,d=0;d<a.length;d++)c=this._getItemInfoFromRow(a[d]),c&&b.push(c);return b},_getItems:function(a){var b=this._getItemsInfo(a);return d.map(b,"item")},_getChangedColumn:function(a){return this.getColumnsGivenEditContext()[a]},_getCell:function(a){if(!a||void 0===a.row||void 0===a.cell)return null;var b=this._getItemInfoFromRow(a.row),c=this.getColumnsGivenEditContext()[a.cell].jpath.slice();c.unshift(b.idx);var d=this.module.data.getChildSync(c);return void 0!==d&&(d=d.get()),d},_getSelectedItems:function(){return this._getItems(this.grid.getSelectedRows())},onResize:function(){this.grid&&this.grid.resizeCanvas(),this.$rowHelp.css({bottom:0})},getNextIncrementalId:function(){return++z},generateUniqIds:function(){if(this.module.data)for(var a=this.module.data.get(),b=0;b<a.length;b++)this.setNextUniqId(a[b])},setNextUniqId:function(a,b){if(!a[this.idPropertyName])if(this.autoIdProperty&&(void 0===a[this.idPropertyName]||b))a[this.idPropertyName]=++z;else if(!this.autoIdProperty&&!a[this.idPropertyName])throw new Error(`An element of slick grid input does not define it's id property "${this.idPropertyName}"`)},_hasFilter:function(){return d.some(this.filterScript.split("\n"),function(a){var b=a.replace(" ","");return!!b&&!b.match(/^\s*\/\/a/)})},_findItem:function(a){var b;if(!this.module.data)return null;var c=this.module.data.get();return"function"==typeof a?c.find(a):(b=d.isNumber(a)||a instanceof DataNumber?c[a]:"string"==typeof a||a instanceof DataString?{[this.idPropertyName]:a+""}:a,b)},exportToTabDelimited:function(){this._makeDataObjects();var a=this.grid.getColumns(),b=[{key:"all",description:"Export entire list"}];this.module.getConfigurationCheckbox("slickCheck","filterColumns")&&b.push({key:"filtered",description:"Export filtered list"}),this.module.getConfigurationCheckbox("slickCheck","editable")&&b.push({key:"selected",description:"Export selected elements"});var c;return h.choose(b,{autoSelect:!0,noConfirmation:!0}).then(b=>{if(b){b+="",c="filtered"===b?this.slick.data.getItems(!0):"selected"===b?d.map(this._getItemsInfo(this.lastSelectedRows||[]),"item"):this.slick.data.getItems();var e,f,g="",h=[];for(e=0;e<a.length;e++)a[e].jpath&&h.push(a[e].name||"");for(g+=`${h.join("\t")}\r\n`,e=0;e<c.length;e++){for(h=[],f=0;f<a.length;f++){var k=a[f].jpath;if(k){var l=c[e].getChildSync(k,!1);l=l?l.get():"","string"==typeof l&&(l=l.replace(/\r/g,"\\r").replace(/\n/g,"\\n").replace(/\t/g,"\\t")),h.push(l)}}g+=`${h.join("\t")}\r\n`}return g}})},hideColumn:function(a){this.hiddenColumns&&(-1!==this.hiddenColumns.indexOf(a)||(this.hiddenColumns.push(a),p(this)))},showColumn:function(a){if(this.hiddenColumns){var b=this.hiddenColumns.indexOf(a);-1<b&&(this.hiddenColumns.splice(b,1),p(this))}},toggleColumn:function(a){var b=this.hiddenColumns.indexOf(a);-1===b?this.hideColumn(a):this.showColumn(a)},getRowIndexes:function(a){var b,c,d=this.module.data.get();if("function"==typeof a)c=d.filter(a);else if("all"===a){b=Array(this.slick.data.getLength());for(var e=0;e<b.length;e++)b[e]=e}else Array.isArray(a)&&(!a.length||a.length&&("number"==typeof a[0]||a[0]instanceof DataNumber))?b=a:Array.isArray(a)?c=a.map(this._findItem.bind(this)):"number"==typeof a||a instanceof DataNumber?b=[a]:a?c=[this._findItem(a)]:b=[];return c&&(b=c.filter(a=>a).map(a=>this.slick.data.getRowById(a[this.idPropertyName]))),b},onActionReceive:{appendRow:function(a){this.onActionReceive.addRow.call(this,a)},prependRow:function(a,...b){if(this.slick.data){Array.isArray(a)||(a=[a]);for(let b,c=0;c<a.length;c++)b=a[c],b=DataObject.resurrect(b),this.setNextUniqId(b,!0),this.slick.data.insertItem(0,b),this._newRow(b)}},addRow:function(a){if(this.slick.data){Array.isArray(a)||(a=[a]);for(let b,c=0;c<a.length;c++)b=a[c],b=DataObject.resurrect(b),this.setNextUniqId(b,!0),this.slick.data.addItem(b),this._newRow(b)}},insertRow:function(a){if(this.slick.data&&!Array.isArray(a)){a=[a];for(let b=0;b<a.length;b++){let{row:c,item:d}=a[b];this.setNextUniqId(d,!0),this.slick.data.insertItem(c,d),this._newRow(d)}}},rerender:function(){this.grid&&(this.grid.invalidateAllRows(),this.grid.render())},hoverRow:function(a){var b=this._findItem(a);if(b&&b[this.idPropertyName]){var c=this.slick.data.getRowById(b[this.idPropertyName]),d=this.slick.data.getIdxById(b[this.idPropertyName]);b=this.slick.data.getItem(d),this.module.controller.onHover(d,b),this.grid.scrollRowToTop(c)}},unsetActiveRow:function(){this.grid.setSelectedRows(this.grid.getSelectedRows().filter(a=>a!==this.lastActiveRow)),this.grid.resetActiveCell(),this.module.controller.unselectRow()},selectRow:function(a){"number"==typeof a&&(a={row:a});var b=this._findItem(a.row);if(b&&b[this.idPropertyName]){var c=this.slick.data.getRowById(b[this.idPropertyName]),e=this.slick.data.getIdxById(b[this.idPropertyName]);b=this.slick.data.getItem();var f=a.column;"number"!=typeof f&&(f=this.slick.columns.findIndex(a=>a.id===f),-1===f&&(f=0)),this.module.controller.onClick(e,b),d.isUndefined(c)||(this.grid.scrollRowToTop(c),this.grid.setActiveCell(c,f||0))}},selectRows:function(a){const b=this.getRowIndexes(a);b&&this.grid.setSelectedRows(b)},unselectRows:function(a){const b=this.getRowIndexes(a),c=this.grid.getSelectedRows(),e=d.difference(c,b);this.grid.setSelectedRows(e)},scrollToRow:function(a){const[b]=this.getRowIndexes(a);this.grid.scrollRowToTop(b)},selectRowsAdd:function(a){const b=this.getRowIndexes(a)||[],c=this.grid.getSelectedRows(),e=d.uniq(d.concat(b,c));this.grid.setSelectedRows(e)},showColumn:function(a){this.showColumn(a)},hideColumn:function(a){this.hideColumn(a)},toggleColumn:function(a){this.toggleColumn(a)}}});var C="";return n});

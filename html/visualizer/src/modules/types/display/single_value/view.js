'use strict';define(["modules/default/defaultview","src/util/util","src/util/api","src/util/typerenderer","src/util/color","sprintf","lodash"],function(a,b,c,d,e,f,g){"use strict";function h(){}function i(a){return j(a)||k(a)}function j(a){return!!a&&(a instanceof DataString||"string"===a.type)}function k(a){return!!a&&(a instanceof DataNumber||"number"===a.type)}function l(a){var b=a.target.innerText;this._lastValueNumber&&(b=+b);let c=this.module.getConfiguration("editSearchRegexp"),d=this.module.getConfiguration("editReplace")||"";if(c){let a=new RegExp(c.replace(/^\/(.*)\/(.*)$/,"$1"),c.replace(/^\/(.*)\/(.*)$/,"$2"));b=b.replace(a,d)}this._lastValue.setValue(b,!0),this.module.model.dataTriggerChange(this._lastValue)}return $.extend(!0,h.prototype,a,{init:function(){var a="<div></div>";this.dom=this.module.getConfigurationCheckbox("append","yes")?$(a).css({height:"100%",width:"100%","overflow-x":"hidden","overflow-y":"scroll"}):$(a).css({display:"table","table-layout":"fixed",height:"100%",width:"100%"}),this.values=[],this.module.getDomContent().html(this.dom),this.fillWithVal({type:"html",value:this.module.getConfiguration("defaultvalue","")}),this.resolveReady(),this._relsForLoading=["value"]},blank:{value:function(){if(this.module.getConfigurationCheckbox("append","yes"))for(var a=this.module.getConfiguration("maxEntries"),b=this.dom.children(),c=b.length-a,d=0;d<c;d++)b[d].remove();else this.dom.empty()},color:function(){this.module.getDomContent().css("background-color","#FFF")}},update:{color:function(a){this.module.getDomContent().css("background-color",a.get())},value:function(a,b){(a instanceof DataNumber||"number"===a.type)&&(this._lastValueNumber=!0);var c=this.values.find(a=>a.name===b);c?c.value=a:(this.values.push({name:b,value:a}),this.values.sort((c,a)=>{var b=this.module.definition.vars_in.findIndex(a=>a.name===c.name),d=this.module.definition.vars_in.findIndex(b=>b.name===a.name);return b<d?-1:1})),this._lastValue=a,this.renderAll()}},onResize:function(){this.renderAll(),this.refresh()},renderAll:function(){var a=this._lastValue;if(a){var c=this,d=this.module.getConfiguration("sprintf"),g=b.evalOptions(this.module.getConfiguration("rendererOptions"))||{},h=this.module.getConfiguration("forceType");if(h&&(g.forceType=h),!d)c.fillWithVal(a,g);else if(!h){var i=[];for(var j of c.values)i.push(this.renderVal(j.value));Promise.all(i).then(function(a){var b=[d].concat(a);c.fillWithVal(f.sprintf.apply(null,b),{forceType:"html"})})}else try{var k=[d];k=k.concat(c.values.map(a=>DataObject.resurrect(a.value.get()))),a=f.sprintf.apply(this,k),c.fillWithVal(a,g)}catch(b){c.fillWithVal(a,g)}}},_scrollDown:function(){var a=this.dom[0].scrollHeight;this.dom.scrollTop(a)},renderVal:function(a,b){var c=$("<span>");return d.render(c,a,b).then(function(){return c.html()}).catch(function(){return"[failed]"})},fillWithVal:function(a,b){var c,f=this,h=this.module.getConfiguration("valign"),j=this.module.getConfiguration("align"),k=this.module.getConfiguration("fontcolor"),m=this.module.getConfiguration("fontsize"),n=this.module.getConfiguration("font"),o=this.module.getConfigurationCheckbox("preformatted","pre"),p=this.module.getConfigurationCheckbox("preformatted","selectable");if(k&&(k=e.getColor(k)),this.module.getConfigurationCheckbox("append","yes"))c=$("<div>").css({fontFamily:n||"Arial",fontSize:m||"10pt",color:k||"#000000","vertical-align":h||"top",textAlign:j||"center",width:"100%","white-space":o?"pre":"normal","word-wrap":"break-word","user-select":p?"text":"none"}),this.dom.append(c);else{c=$("<div />").css({fontFamily:n||"Arial",fontSize:m||"10pt",color:k||"#000000",display:"table-cell","vertical-align":h||"top",textAlign:j||"center",width:"100%",height:"100%","white-space":o?"pre":"normal","word-wrap":"break-word","user-select":p?"text":"none"}),this.dom.html(c);var q;this.module.getConfigurationCheckbox("editable","yes")&&i(this._lastValue)&&(c.attr("contenteditable",!0),c.on("input",0<f.module.getConfiguration("debounce")?g.debounce(l,f.module.getConfiguration("debounce")).bind(f):l.bind(f)),c.on("keyup",function(a){27===a.keyCode&&c.blur()}),c.on("click",function(){q||(q=!0,c.html(a+""),c.focus())}),c.on("blur",function(){q=!1,d.render(c,a,b).then(function(){f._scrollDown()})}))}this._scrollDown(),d.render(c,a,b).then(function(){f._scrollDown()})}}),h});

'use strict';define(["modules/default/defaultcontroller","x2js"],function(a,b){"use strict";function c(){this.running=!1,this.runners=[],this.variables=new DataObject,this.converter=new b}return $.extend(!0,c.prototype,a),c.prototype.moduleInformation={name:"Webservice Cron",description:"Cron service allowing to fetch data from the server",author:"Norman Pellet, Luc Patiny, Micha\xEBl Zasso",date:"11.01.2014",license:"MIT",cssClass:"webservice_cron"},c.prototype.start=function(){this.running&&this.stop(),this.doVariables()},c.prototype.stop=function(){if(this.running){for(var a=0,b=this.runners.length;a<b;a++)window.clearInterval(this.runners[a]);this.runners=[],this.variables=new DataObject,this.running=!1}},c.prototype.references={result:{label:"Global result",type:"object"}},c.prototype.events={onUpdateResult:{label:"Updated result",refVariable:["result"]}},c.prototype.doVariables=function(){var a,b,c,d,e=this.module.getConfiguration("cronInfos");if(e){for(var f=0,g=e.length;f<g;f++)a=e[f].variable,b=e[f].repeat,c=e[f].url,d=e[f].datatype,this.doAjax(this,a,c,d),this.runners[f]=window.setInterval(this.doAjax,1e3*b,this,a,c,d);this.running=!0}},c.prototype.doAjax=function(a,b,c,d){var e={url:c,dataType:"text"};e.success=function(c){var e;"json"===d?e=JSON.parse(c):"xml"==d&&(e=a.converter.xml_str2json(c)),a.addVar(b,DataObject.check(e,!0)),a.createDataFromEvent("onUpdateResult","result",e),a.module.view.log(!0,b)},e.method="get",e.type="get",e.error=function(){a.module.view.log(!1,b)},$.ajax(e)},c.prototype.addVar=function(a,b){this.variables[a]=b},c.prototype.configurationStructure=function(){return{groups:{group:{options:{type:"list"},fields:{max:{type:"float",title:"Max number of logs",default:10}}},cronInfos:{options:{type:"table",multiple:!0},fields:{variable:{type:"text",title:"Variable",default:""},url:{type:"text",title:"URL",default:""},datatype:{type:"combo",title:"Data type",options:[{title:"Text",key:"text"},{title:"JSON",key:"json"},{title:"XML",key:"xml"}],default:"json"},repeat:{type:"text",title:"Repetition time (s)",default:"60"}}}}}},c.prototype.configAliases={cronInfos:["groups","cronInfos",0],maxLogs:["groups","group",0,"max",0]},c.prototype.onRemove=function(){this.stop()},c});

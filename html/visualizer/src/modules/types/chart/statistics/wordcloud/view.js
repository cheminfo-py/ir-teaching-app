'use strict';define(["modules/default/defaultview","src/util/util","src/util/ui","lib/d3/d3.layout.cloud"],function(a,b,c,d){"use strict";function e(){}return e.prototype=$.extend(!0,{},a,{init:function(){this._id=b.getNextUniqueId(),this.dom=c.getSafeElement("div").attr("id",this._id).attr("class","layout-cloud"),this.module.getDomContent().html(this.dom)},blank:{arrayvalue:function(){this.dom.empty()},textvalue:function(){this.dom.empty()}},update:{arrayvalue:function(a){a.get()&&(a=a.get(),Array.isArray(a)&&this.processChart(a))},textvalue:function(a){a.get()&&(a=a.get(),this.processChart(a))}},onActionReceive:{},inDom:function(){this.resolveReady()},onResize:function(){this.layout&&(this.dom.empty(),this.drawChart(),this.refresh())},processChart:function(a){function b(a){f={};for(var b={},c=a.length-1;0<=c;c--){var g=a[c][0],k=a[c][1];if(g!==parseInt(g,10)&&k===parseInt(k,10)){var m=g;g=k,k=m}if(l.test(k))return;if(k=k.replace(j,""),h.test(k.toLowerCase()))return;b[k.toLowerCase()]=k,f[k=k.toLowerCase()]=(f[k]||0)+g}f=d.entries(f).sort(function(c,a){return a.value-c.value}),f.forEach(function(a){a.key=b[a.key]}),e()}function c(a){f={};var b={};a.split(g.module.getConfigurationCheckbox("oneWordPerLine","oneWordPerLine")?/\n/g:k).forEach(function(a){l.test(a)||(a=a.replace(j,""),h.test(a.toLowerCase())||(b[a.toLowerCase()]=a,f[a=a.toLowerCase()]=(f[a]||0)+1))}),f=d.entries(f).sort(function(c,a){return a.value-c.value}),f.forEach(function(a){a.key=b[a.key]}),e()}function e(){g.layout.spiral(g.module.getConfiguration("spiral")),g.fontSize=d.scale[g.module.getConfiguration("scale")]().range([10,100]),f.length&&g.fontSize.domain([+f[f.length-1].value||1,+f[0].value]),g.words=[],g.layout.stop().words(f).start()}var f,g=this;g.words=[];var h=/^(i|me|my|myself|we|us|our|ours|ourselves|you|your|yours|yourself|yourselves|he|him|his|himself|she|her|hers|herself|it|its|itself|they|them|their|theirs|themselves|what|which|who|whom|whose|this|that|these|those|am|is|are|was|were|be|been|being|have|has|had|having|do|does|did|doing|will|would|should|can|could|ought|i'm|you're|he's|she's|it's|we're|they're|i've|you've|we've|they've|i'd|you'd|he'd|she'd|we'd|they'd|i'll|you'll|he'll|she'll|we'll|they'll|isn't|aren't|wasn't|weren't|hasn't|haven't|hadn't|doesn't|don't|didn't|won't|wouldn't|shan't|shouldn't|can't|cannot|couldn't|mustn't|let's|that's|who's|what's|here's|there's|when's|where's|why's|how's|a|an|the|and|but|if|or|because|as|until|while|of|at|by|for|with|about|against|between|into|through|during|before|after|above|below|to|from|up|upon|down|in|out|on|off|over|under|again|further|then|once|here|there|when|where|why|how|all|any|both|each|few|more|most|other|some|such|no|nor|not|only|own|same|so|than|too|very|say|says|said|shall)$/,j=/[!-#%-*,-/:;?@\[-\]_{}¡§«¶·»¿;·՚-՟։֊־׀׃׆׳״؉؊،؍؛؞؟٪-٭۔܀-܍߷-߹࠰-࠾࡞।॥॰૰෴๏๚๛༄-༒༔༺-༽྅࿐-࿔࿙࿚၊-၏჻፠-፨᐀᙭᙮᚛᚜᛫-᛭᜵᜶។-៖៘-៚᠀-᠊᥄᥅᨞᨟᪠-᪦᪨-᪭᭚-᭠᯼-᯿᰻-᰿᱾᱿᳀-᳇᳓‐-‧‰-⁃⁅-⁑⁓-⁞⁽⁾₍₎〈〉❨-❵⟅⟆⟦-⟯⦃-⦘⧘-⧛⧼⧽⳹-⳼⳾⳿⵰⸀-⸮⸰-⸻、-〃〈-】〔-〟〰〽゠・꓾꓿꘍-꘏꙳꙾꛲-꛷꡴-꡷꣎꣏꣸-꣺꤮꤯꥟꧁-꧍꧞꧟꩜-꩟꫞꫟꫰꫱꯫﴾﴿︐-︙︰-﹒﹔-﹡﹣﹨﹪﹫！-＃％-＊，-／：；？＠［-］＿｛｝｟-･]/g,k=/[ \f\n\r\t\v\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u2028\u2029\u202f\u205f\u3000\u3031-\u3035\u309b\u309c\u30a0\u30fc\uff70]+/g,l=/^(@|https?:|\/\/)/;g.drawChart(),Array.isArray(a)?b(a):c(a)},drawChart:function(){function a(a,d){var g=d?Math.min(e/Math.abs(d[1].x-e/2),e/Math.abs(d[0].x-e/2),f/Math.abs(d[1].y-f/2),f/Math.abs(d[0].y-f/2))/2:1;b.words=a;var j=i.selectAll("text").data(b.words,function(a){return a.text.toLowerCase()});j.transition().duration(1e3).attr("transform",function(a){return`translate(${[a.x,a.y]})rotate(${a.rotate})`}).style("font-size",function(a){return`${a.size}px`}),j.enter().append("text").attr("text-anchor","middle").attr("transform",function(a){return`translate(${[a.x,a.y]})rotate(${a.rotate})`}).style("font-size","1px").transition().duration(1e3).style("font-size",function(a){return`${a.size}px`}),j.style("font-family",function(a){return a.font}).style("fill",function(a){return c(a.text.toLowerCase())}).text(function(a){return a.text});var k=h.append("g").attr("transform",i.attr("transform")),l=k.node();j.exit().each(function(){l.appendChild(this)}),k.transition().duration(1e3).style("opacity",1e-6).remove(),i.transition().delay(1e3).duration(750).attr("transform",`translate(${[e>>1,f>>1]})scale(${g})`)}var b=this,c=d.scale.category20b(),e=this.width,f=this.height,g=d.select(`#${this._id}`).append("svg").attr("width",e).attr("height",f).style("display","block"),h=g.append("g"),i=g.append("g").attr("transform",`translate(${[e>>1,f>>1]})`),j=b.module.getConfiguration("fromTo")?Math.max(-90,Math.min(90,+b.module.getConfiguration("fromTo")[0])):0,k=b.module.getConfiguration("fromTo")?Math.max(-90,Math.min(90,+b.module.getConfiguration("fromTo")[1])):0,l=0<b.module.getConfiguration("orientation")?b.module.getConfiguration("orientation"):1;b.layout?(b.layout.rotate(function(){return~~(Math.random()*l)*j-k}).size([e,f]).on("end",a),b.layout.stop().start()):b.layout=d.layout.cloud().timeInterval(10).rotate(function(){return~~(Math.random()*l)*j-k}).size([e,f]).fontSize(function(a){return b.fontSize(+a.value)}).text(function(a){return a.key}).on("end",a)}}),e});

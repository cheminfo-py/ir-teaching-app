'use strict';define(["modules/default/defaultview","src/main/datas","src/util/datatraversing","src/util/api","src/util/util","src/util/color","src/util/colorbar","lodash","threejs","src/util/debug","chroma","components/ml/dist/ml.min","lib/threejs/TrackballControls"],function(a,b,c,d,e,f,g,h,k,l,m,n){"use strict";function i(a){switch(a.preventDefault(),a.keyCode){case 38:s+=t;break;case 40:s-=t;break;case 39:t*=1.1;break;case 37:t*=.9;}}function j(a){var b=a.toString(16);return 1==b.length?`0${b}`:b}function o(a,c,d){return`#${j(a)}${j(c)}${j(d)}`}function p(a,b){a=`${a}`;var c=a.indexOf(".");return-1===c?+a:a.slice(0,c+b+1)}function q(){this._firstLoad=!0}function r(){var a=this;this.scene&&this.scene.children&&(h.keys(this.scene.children).forEach(function(b){a.scene.remove(a.scene.children[b])}),this._render())}var s=.55,t=.001,u=n.Stat;(function(){document.addEventListener("keyup",i,!1)})();var w=1e3,x=100,y="#eeeeee",z="lightblue",A=.03,B="sphere",C=w/1e3,D=2,E=1e4,F=`${require.toUrl("modules/types/chart/basic/scatter3D")}/`,G={sphere:`${F}img/ball.png`,spheret:`${F}img/ballt.png`,tetrahedron:`${F}img/tetrahedron2.png`,tetrahedront:`${F}img/tetrahedron2t.png`,cone:`${F}img/cone.png`,conet:`${F}img/conet.png`,cube:`${F}img/cube.png`,cubet:`${F}img/cubet.png`,pyramid:`${F}img/pyramid.png`,pyramidt:`${F}img/pyramidt.png`,cylinder:`${F}img/cylinder.png`,cylindert:`${F}img/cylindert.png`,cuboid:`${F}img/cuboid.png`,cuboidt:`${F}img/cuboidt.png`};return function(a){for(var b in a)k.ImageUtils.loadTexture(a[b])}(G),$.fn.listHandlers=function(a,b){return this.each(function(){var c=this,d=$(this).data("events");d&&$.each(d,function(d,e){new RegExp(`^(${"*"===a?".+":a.replace(",","|").replace(/^on/i,"")})$`,"i").test(d)&&$.each(e,function(a,e){b(c,`\n${a}: [${d}] : ${e}`)})})})},$.extend(!0,q.prototype,a,{_initThreejs:function(){function a(a){var b,c;b="sideBySide"===q._3d?q.width/2:q.width;var c=q.height,d=new k.Vector3(2*(a.offsetX/b)-1,2*-(a.offsetY/c)+1,.5);d.unproject(q.camera);for(var e=new k.Ray(q.camera.position,d.sub(q.camera.position).normalize()),f=0,g=[],j=0;j<q.mathPoints.length;j++)e.isIntersectionSphere(q.mathPoints[j])&&(f++,g.push({index:q.mathPoints[j].index,distance:q.camera.position.distanceTo(q.mathPoints[j].center)}));return g.sort(A),g=h.filter(g,function(a){return a.distance>D}),g=h.map(g,function(a){return a.index}),g}function b(a){if(q._configCheckBox("displayPointCoordinates","onhover")){var b=[`X: ${parseFloat(q._data.x[a].toPrecision(3)).toExponential()}`,`Y: ${parseFloat(q._data.y[a].toPrecision(3)).toExponential()}`,`Z: ${parseFloat(q._data.z[a].toPrecision(3)).toExponential()}`],c=$("#legend_point_coordinates");c.html(b.join("<br/>")),c.show()}}function c(){q._configCheckBox("displayPointCoordinates","onhover")&&$("#legend_point_coordinates").hide()}function e(e){var f;if(f=a(e),r=f,t=e,0<f.length){var g=f[0],h=g,i=h!==u;u&&i?(d.highlightId(q._data._highlight[u],0),d.highlightId(q._data._highlight[h],1),b(g)):i&&(d.highlightId(q._data._highlight[h],1),b(g)),u=h}else null!==u&&(d.highlightId(q._data._highlight[u],0),c()),u=null}function f(){if(0!==r.length){var a=q.module.getConfiguration("tooltipJpath");if(a){var b=q._data;if(b.info){var c=b.info[r[0]],d=c.getChildSync(a),e=q.$tooltip;e.css("left",t.offsetX-x),e.css("top",t.offsetY),e.css("width",x),e.html(d.value),e.show()}}}}function g(){q.$tooltip.hide()}function i(){if(0!==r.length){var a=r[0];0<z.length&&j();var b={color:8947848},c=new k.Vector3(q._data.normalizedData.x[a],q._data.normalizedData.y[a],q._data.normalizedData.z[a]),d=new k.Vector3(q._data.normalizedData.x[a],q._data.normalizedData.y[a],0);z.push(q._drawLine(c,d,b)),z.push(q._drawCircle({color:"#000000",radius:q._data.size[a],x:q._data.normalizedData.x[a],y:q._data.normalizedData.y[a],z:C+q.gorigin.z})),d=new k.Vector3(q._data.normalizedData.x[a],0,q._data.normalizedData.z[a]),z.push(q._drawLine(c,d,b)),z.push(q._drawCircle({rotationAngle:Math.PI/2,rotationAxis:{x:1},color:"#000000",radius:q._data.size[a],x:q._data.normalizedData.x[a],y:C+q.gorigin.y,z:q._data.normalizedData.z[a]})),d=new k.Vector3(0,q._data.normalizedData.y[a],q._data.normalizedData.z[a]),z.push(q._drawLine(c,d,b)),z.push(q._drawCircle({rotationAngle:Math.PI/2,rotationAxis:{y:1},color:"#000000",radius:q._data.size[a],x:C+q.gorigin.x,y:q._data.normalizedData.y[a],z:q._data.normalizedData.z[a]})),o()}}function j(){for(var a=0;a<z.length;a++)q.scene.remove(z[a]);z=[],o()}function l(){function a(){if(0<r.length){var a=r[0];q.module.controller.onHover(a)}}q.camera=q.camera||new k.PerspectiveCamera(60,q.width/q.height,D,E),q.cameraLeft=q.cameraLeft||new k.PerspectiveCamera(60,q.width/q.height,D,E),q.cameraRight=q.cameraRight||new k.PerspectiveCamera(60,q.width/q.height,D,E),q.controls||(q.controls=new k.TrackballControls(q.camera,q.dom.get(0)),q.controls.rotateSpeed=1,q.controls.zoomSpeed=1.2,q.controls.panSpeed=.8,q.controls.noZoom=!1,q.controls.noPan=!1,q.controls.staticMoving=!0,q.controls.dynamicDampingFactor=.3,q.controls.keys=[65,83,68],q.controls.addEventListener("change",o)),q.scene=new k.Scene,q.renderer=new k.WebGLRenderer({antialias:!1}),q._setBackgroundColor(),q.renderer.setSize(window.innerWidth,window.innerHeight),p=document.getElementById(q.dom.attr("id")),p.innerHTML="",p.appendChild(q.renderer.domElement),q.$tooltip=$(`<div style="z-index: 10000; position:absolute; top: 20px; width:${x+100}px; height: auto; background-color: #f9edbe;"> </div>`),$(q.dom).append(q.$tooltip),q.$colorbar=$("<div>"),$(q.dom).append(q.$colorbar),q.$tooltip.hide(),$(q.dom).append("<div id=\"legend\" style=\"z-index: 10000; right:10px ;position:absolute; top: 25px; height: auto; background-color: #ffffff;\"> </div>");var b=$("#legend");b.append("<div id=\"legend_titles\"></div>"),b.append("<div id=\"legend_point_coordinates\"></div>"),b.css("background-color",q.module.getConfiguration("backgroundColor")).css("text-align","right"),$("#legend_titles").hide(),$("#legend_point_coordinates").hide(),m(),$(q.renderer.domElement).on("mousemove",h.throttle(e,100)),$(q.renderer.domElement).on("mousemove",h.throttle(a,300)),q._configCheckBox("tooltip","show")&&($(q.renderer.domElement).on("mousemove",h.debounce(f,500)),$(q.renderer.domElement).on("mousemove",h.throttle(g,500))),q._configCheckBox("projection","show")&&($(q.renderer.domElement).on("mousemove",h.debounce(i,500)),$(q.renderer.domElement).on("mousemove",h.throttle(j,500))),$(q.renderer.domElement).listHandlers("mousemove",function(){})}function m(){q.camera.aspect=q.width/q.height,q.camera.updateProjectionMatrix(),q.renderer.setSize(q.width,q.height),q.controls.handleResize(),o()}function n(){if(requestAnimationFrame(n),q.controls.update(),q._3d){q.camera.updateMatrix();var a=new k.Vector3(-s,0,0),b=new k.Vector3(s,0,0);q.camera.localToWorld(a),q.camera.localToWorld(b),q.cameraLeft.position.x=a.x,q.cameraLeft.position.y=a.y,q.cameraLeft.position.z=a.z,q.cameraLeft.rotation.x=q.camera.rotation.x,q.cameraLeft.rotation.y=q.camera.rotation.y,q.cameraLeft.rotation.z=q.camera.rotation.z,q.cameraLeft.updateMatrix(),q.cameraRight.position.x=b.x,q.cameraRight.position.y=b.y,q.cameraRight.position.z=b.z,q.cameraRight.rotation.x=q.camera.rotation.x,q.cameraRight.rotation.y=q.camera.rotation.y,q.cameraRight.rotation.z=q.camera.rotation.z,q.cameraRight.updateMatrix()}}function o(){q._render(),q.headlight&&(q.headlight.position.x=q.camera.position.x+200,q.headlight.position.y=q.camera.position.y+200,q.headlight.position.z=q.camera.position.z+200),q.tickLabels&&(v(),w(),y())}var p,q=this,r=[],t=null,u=null,v=h.throttle(this._drawTickLabels.bind(this),500),w=h.throttle(this._drawAxisLabels.bind(this),500),y=h.throttle(this._drawGraphTitle.bind(this),500),z=[];l(),n();const A=(c,a)=>c.distance-a.distance},_drawGraph:function(){var a=this;h.keys(a.scene.children).forEach(function(b){a.scene.remove(a.scene.children[b])});var b;b=new k.AmbientLight(2236962,1),a.scene.add(b),a.headlight=new k.PointLight(11184810,1.5),a.headlight.position.set(1e3,1e3,1e3),a.scene.add(a.headlight),a._mathPoints(),a._drawPointsQuick(),a._drawFaces(),a._drawGrid(),a._drawSecondaryGrid(),a._drawTicks(),a._drawTickLabels(),a._drawAxisLabels(),a._drawGraphTitle(),a._render()},_drawPointsQuick:function(){var a=this;if(a._mainParticleObjects)for(var b in a._mainParticleObjects)a.scene.remove(a._mainParticleObjects[b]);a._mainParticleObjects={};for(var c={},d=0;d<a._data.shape.length;d++)c[a._data.shape[d]]=c[a._data.shape[d]]||[],c[a._data.shape[d]].push(d);for(var b in c)a._mainParticleObjects[b]=a._newParticleObject(c[b],{shape:b}),a._updateParticleObject(a._mainParticleObjects[b]),a.scene.add(a._mainParticleObjects[b]);a._doRender()},_configCheckBox:function(a,b){return this.module.getConfiguration(a)&&h.find(this.module.getConfiguration(a),function(a){return a===b})},_getDataField:function(a){return this._data?h.flatten(h.map(this._data.data,a)):[]},_normalizeData:function(){var a=this;if(this._data){a._data.normalizedData={},a._data.normalizedData.x=h.map(a._data.x,function(b){return w*(b-a._data.realMin.x)/a._data.realLen.x}),a._data.normalizedData.y=h.map(a._data.y,function(b){return w*(b-a._data.realMin.y)/a._data.realLen.y}),a._data.normalizedData.z=h.map(a._data.z,function(b){return w*(b-a._data.realMin.z)/a._data.realLen.z});var b=this.module.getConfiguration("sizeNormalization"),c=u.array.min(a._data.size),d=u.array.max(a._data.size),e=d-c;a._data.size=h.map(a._data.size,function(a){return 0===e?b/2:b*((a-c)/e+.01)})}},_processColors:function(){this.colorDomain=h.filter(this._data.color,function(a){return!isNaN(a)}),this.colorDomain=[Math.min.apply(null,this.colorDomain),Math.max.apply(null,this.colorDomain)];var a=this.module.getConfiguration("gradient");a=h.filter(a,function(a){return void 0!==a.stopPosition}),this.stopPositions=h.map(a,"stopPosition"),this.stopColors=h(a).map("color").map(f.getColor).map(a=>f.rgb2hex(a)).value(),this.numberToColor=g.getColorScale({stops:this.stopColors,stopPositions:this.stopPositions,domain:this.colorDomain});for(var b=0;b<this._data.color.length;b++)if(!isNaN(this._data.color[b])&&(this._data.color[b]=this.numberToColor(this._data.color[b]).color,Number.isNaN(this._data.color[b]))){this._data.color[b]=z;continue}for(b=0;b<this._data.color.length;b++)this._data.color[b]=new m(this._data.color[b]).hex()},_computeMinMax:function(){var a=this;if(a._data){a.minMax={};var b=a._data.x,c=a._data.y,d=a._data.z;a._data.min={},a._data.max={},a._data.len={};var e=a._meta.getChildSync(["axis",0,"min"]),f=a._meta.getChildSync(["axis",0,"max"]),g=a._meta.getChildSync(["axis",1,"min"]),h=a._meta.getChildSync(["axis",1,"max"]),i=a._meta.getChildSync(["axis",2,"min"]),j=a._meta.getChildSync(["axis",2,"max"]);a._data.min.x=parseFloat(a.module.getConfiguration("minX"))||e&&e.get()||u.array.min(b),a._data.min.y=parseFloat(a.module.getConfiguration("minY"))||g&&g.get()||u.array.min(c),a._data.min.z=parseFloat(a.module.getConfiguration("minZ"))||i&&i.get()||u.array.min(d),a._data.max.x=parseFloat(a.module.getConfiguration("maxX"))||f&&f.get()||u.array.max(b),a._data.max.y=parseFloat(a.module.getConfiguration("maxY"))||h&&h.get()||u.array.max(c),a._data.max.z=parseFloat(a.module.getConfiguration("maxZ"))||j&&j.get()||u.array.max(d),a._data.len.x=a._data.max.x-a._data.min.x,a._data.len.y=a._data.max.y-a._data.min.y,a._data.len.z=a._data.max.z-a._data.min.z}},_getUnitPerTick:function(a,b,c,d){var e=this,f=a/p;b=b?Math.min(b,a/10):a/10;for(var g=c/b,j=Math.floor(Math.log(g)/Math.log(10)),k=g*Math.pow(10,-j),l=[1,2,5,10],m=!1,n=l.length-1;0<=n;n--)(!m||Math.abs(l[n]-k)<Math.abs(m-k))&&(m=l[n]);var o=m*Math.pow(10,j),p=c/o,f=a/b;e._data.realMin[d]=Math.floor(e._data.min[d]/o)*o,e._data.realMax[d]=Math.ceil(e._data.max[d]/o)*o,e._data.realMin[d]!==e._data.min[d]&&p++,e._data.realMax[d]!==e._data.max[d]&&p++,e._data.intervalVal[d]=o,e._data.realLen[d]=e._data.realMax[d]-e._data.realMin[d],e._data.nbTicks[d]=Math.round((e._data.realMax[d]-e._data.realMin[d])/e._data.intervalVal[d]+1),e._data.intervalPx[d]=w/(e._data.nbTicks[d]-1),e._data.decimals[d]=j;var q=Math.floor(Math.log(o)/Math.log(10));if(e._data.intervalFactor[d]=1>=Math.abs(q)?1:Math.pow(10,q),!h.isFinite(e._data.intervalPx[d])){e._data.nbTicks[d]=3,e._data.intervalPx[d]=w/2;var r=e._data[d][0];e._data.decimals[d]=0===e._data[d][0]?0:Math.floor(Math.log(Math.abs(r))/Math.log(10)),e._data.intervalFactor[d]=Math.pow(10,e._data.decimals[d]);var s=e._data.intervalFactor[d];e._data.realMin[d]=Math.ceil((r-s)/s)*s,e._data.realMax[d]=Math.floor((r+s)/s)*s,e._data.realLen[d]=e._data.realMax[d]-e._data.realMin[d],e._data.intervalVal[d]=e._data.realLen[d]/2}},_computeTickInfo:function(){var a=this;a._data.realMin={},a._data.realMax={},a._data.realLen={},a._data.intervalPx={},a._data.nbTicks={},a._data.intervalVal={},a._data.decimals={},a._data.intervalFactor={},a._getUnitPerTick(w,3,a._data.len.x,"x"),a._getUnitPerTick(w,3,a._data.len.y,"y"),a._getUnitPerTick(w,3,a._data.len.z,"z")},_drawAxes:function(){var a=this;if(a._data){a._reinitObject3DArray("axes");var b=new k.Vector3(1,0,0),c=new k.Vector3(0,1,0),d=new k.Vector3(0,0,-1),e=new k.Vector3(0,0,0),f=0,g=new k.ArrowHelper(b,new k.Vector3(0,0,w),w,f,1,1),h=new k.ArrowHelper(c,new k.Vector3(0,0,w),w,f,1,1),i=new k.ArrowHelper(d,new k.Vector3(w,0,w),w,f,1,1);a.axes.push(g,h,i),this.scene.add(g),this.scene.add(h),this.scene.add(i)}},_drawCircle:function(a){var a=a||{},b=new k.Shape,c=a.radius||A;c*=w;for(var d=0;16>d;d++){var e=(d+1)/16,f=2*(e*Math.PI),g=c*Math.cos(f),h=c*Math.sin(f);0==d?b.moveTo(g,h):b.lineTo(g,h)}var j=b.makeGeometry(),l=new k.MeshBasicMaterial({color:a.color||"#888888",side:k.DoubleSide}),m=new k.Mesh(j,l),n=new k.Matrix4,o=new k.Matrix4;return a.rotationAxis&&n.makeRotationAxis(new k.Vector3(a.rotationAxis.x||0,a.rotationAxis.y||0,a.rotationAxis.z||0),a.rotationAngle||0),o.makeTranslation(a.x||0,a.y||0,a.z||0),o.multiplyMatrices(o,n),m.applyMatrix(o),this.scene.add(m),m},_drawColorBar:function(){this.$colorbar.empty(),this.$colorbar.css({position:"absolute",top:0}),!this.module.getConfiguration("gradient")||1>=this.module.getConfiguration("gradient").length||g.renderSvg(this.$colorbar[0],{width:50,height:200,axis:{orientation:"left",ticks:5,order:"asc"},stops:this.stopColors,stopPositions:this.stopPositions,domain:this.colorDomain})},_drawLine:function(a,b,c){c=c||{};var d=new k.LineBasicMaterial({color:c.color||0}),e=new k.Geometry;e.vertices.push(a),e.vertices.push(b);var f=new k.Line(e,d);return this.scene.add(f),f},_reinitObject3DArray:function(a){this[a]=this[a]||[];for(var b=0;b<this[a].length;b++)this.scene.remove(this[a][b]);this[a]=[]},_setGridOrigin:function(){this.gorigin={},this.gorigin.x=parseFloat(this.module.getConfiguration("gridOriginX")||this._data.realMin.x),this.gorigin.y=parseFloat(this.module.getConfiguration("gridOriginY")||this._data.realMin.y),this.gorigin.z=parseFloat(this.module.getConfiguration("gridOriginZ")||this._data.realMin.z),this.gorigin.x=w*(this.gorigin.x-this._data.realMin.x)/this._data.realLen.x,this.gorigin.y=w*(this.gorigin.y-this._data.realMin.y)/this._data.realLen.y,this.gorigin.z=w*(this.gorigin.z-this._data.realMin.z)/this._data.realLen.z},_drawSecondaryGrid:function(){var a=this;a._reinitObject3DArray("secondaryGrid");for(var b={color:8947848},c=a.module.getConfiguration("secondaryGrids")||2,d=0;d<a._data.nbTicks.x-1;d++)for(var e=1;e<c;e++)this._configCheckBox("grid","xysec")&&a.secondaryGrid.push(a._drawLine(new k.Vector3(a._data.intervalPx.x*d+a._data.intervalPx.x/c*e,0,C+a.gorigin.z),new k.Vector3(a._data.intervalPx.x*d+a._data.intervalPx.x/c*e,w,C+a.gorigin.z),b)),this._configCheckBox("grid","xzsec")&&a.secondaryGrid.push(a._drawLine(new k.Vector3(a._data.intervalPx.x*d+a._data.intervalPx.x/c*e,C+a.gorigin.y,0),new k.Vector3(a._data.intervalPx.x*d+a._data.intervalPx.x/c*e,C+a.gorigin.y,w),b));for(var d=0;d<a._data.nbTicks.y-1;d++)for(var e=1;e<c;e++)this._configCheckBox("grid","yzsec")&&a.secondaryGrid.push(a._drawLine(new k.Vector3(C+a.gorigin.x,a._data.intervalPx.y*d+a._data.intervalPx.y/c*e,0),new k.Vector3(C+a.gorigin.x,a._data.intervalPx.y*d+a._data.intervalPx.y/c*e,w),b)),this._configCheckBox("grid","xysec")&&a.secondaryGrid.push(a._drawLine(new k.Vector3(0,a._data.intervalPx.y*d+a._data.intervalPx.y/c*e,C+a.gorigin.z),new k.Vector3(w,a._data.intervalPx.y*d+a._data.intervalPx.y/c*e,C+a.gorigin.z),b));for(var d=0;d<a._data.nbTicks.z-1;d++)for(var e=1;e<c;e++)this._configCheckBox("grid","yzsec")&&a.secondaryGrid.push(a._drawLine(new k.Vector3(C+a.gorigin.x,0,a._data.intervalPx.z*d+a._data.intervalPx.z/c*e),new k.Vector3(C+a.gorigin.x,w,a._data.intervalPx.z*d+a._data.intervalPx.z/c*e),b)),this._configCheckBox("grid","xzsec")&&a.secondaryGrid.push(a._drawLine(new k.Vector3(0,C+a.gorigin.y,a._data.intervalPx.z*d+a._data.intervalPx.z/c*e),new k.Vector3(w,C+a.gorigin.y,a._data.intervalPx.z*d+a._data.intervalPx.z/c*e),b))},_drawGrid:function(){var a=this;a._reinitObject3DArray("grid");for(var b=0;b<a._data.nbTicks.x;b++)this._configCheckBox("grid","xy")&&a.grid.push(a._drawLine(new k.Vector3(a._data.intervalPx.x*b,0,C+a.gorigin.z),new k.Vector3(a._data.intervalPx.x*b,w,C+a.gorigin.z))),this._configCheckBox("grid","xz")&&a.grid.push(a._drawLine(new k.Vector3(a._data.intervalPx.x*b,C+a.gorigin.y,0),new k.Vector3(a._data.intervalPx.x*b,C+a.gorigin.y,w)));for(var b=0;b<a._data.nbTicks.y;b++)this._configCheckBox("grid","yz")&&a.grid.push(a._drawLine(new k.Vector3(C+a.gorigin.x,a._data.intervalPx.y*b,0),new k.Vector3(C+a.gorigin.x,a._data.intervalPx.y*b,w))),this._configCheckBox("grid","xy")&&a.grid.push(a._drawLine(new k.Vector3(0,a._data.intervalPx.y*b,C+a.gorigin.z),new k.Vector3(w,a._data.intervalPx.y*b,C+a.gorigin.z)));for(var b=0;b<a._data.nbTicks.z;b++)this._configCheckBox("grid","yz")&&a.grid.push(a._drawLine(new k.Vector3(C+a.gorigin.x,0,a._data.intervalPx.z*b),new k.Vector3(C+a.gorigin.x,w,a._data.intervalPx.z*b))),this._configCheckBox("grid","xz")&&a.grid.push(a._drawLine(new k.Vector3(0,C+a.gorigin.y,a._data.intervalPx.z*b),new k.Vector3(w,C+a.gorigin.y,a._data.intervalPx.z*b)))},_drawTicks:function(){var a=this;if(a._reinitObject3DArray("ticks"),a._configCheckBox("ticks","x"))for(var b=0;b<a._data.nbTicks.x;b++)a.ticks.push(a._drawLine(new k.Vector3(a._data.intervalPx.x*b,0,w),new k.Vector3(a._data.intervalPx.x*b,0,1.05*w)));if(a._configCheckBox("ticks","y"))for(var b=0;b<a._data.nbTicks.y;b++)a.ticks.push(a._drawLine(new k.Vector3(0,a._data.intervalPx.y*b,w),new k.Vector3(-.05*w,a._data.intervalPx.y*b,w)));if(a._configCheckBox("ticks","z"))for(var b=0;b<a._data.nbTicks.z;b++)a.ticks.push(a._drawLine(new k.Vector3(w,0,a._data.intervalPx.z*b),new k.Vector3(1.05*w,0,a._data.intervalPx.z*b)))},_addText:function(a,b,c,d,e){var g=this,e=e||{};e.size=e.size||64,e.fillStyle=e.fillStyle||f.array2rgba(g.module.getConfiguration("annotationColor"))||"rgba(0,0,0,1)",e.textAlign=e.textAlign||"left",e.font=e.font||"Arial",e.opacity=e.opacity||.99;var h=document.createElement("canvas");switch(h.height=e.size,h.width=e.size*a.length/2+e.size/2,e.textAlign){case"left":b+=h.width/2;break;case"right":b-=h.width/2;}var i=h.getContext("2d");i.font=`Bold ${.9*e.size}px ${e.font}`,i.fillStyle=e.fillStyle,i.fillText(a,0,.9*e.size);var j=new k.Texture(h);j.minFilter=k.NearestFilter,j.needsUpdate=!0;var l=new k.MeshBasicMaterial({map:j,transparent:1!==e.opacity,opacity:e.opacity}),m=new k.Mesh(new k.PlaneBufferGeometry(h.width,h.height),l),n=g.camera.matrix.clone();return n.setPosition(new k.Vector3(0,0,0)),m.applyMatrix(n),m.position.set(b,c,d),m.castShadow=!1,m.receiveShadow=!1,g.scene.add(m),m},_drawTickLabels:function(){var a=this;if(a._reinitObject3DArray("tickLabels"),a._configCheckBox("ticks","zlab"))for(var b,c=0;c<a._data.nbTicks.z;c++)b=p((a._data.realMin.z+c*a._data.intervalVal.z)/a._data.intervalFactor.z,2).toString(),a.tickLabels.push(a._addText(b,1.1*w,0,c*a._data.intervalPx.z,{textAlign:"left"}));if(a._configCheckBox("ticks","ylab"))for(var b,c=0;c<a._data.nbTicks.y;c++)b=p((a._data.realMin.y+c*a._data.intervalVal.y)/a._data.intervalFactor.y,2).toString(),a.tickLabels.push(a._addText(b,-.05*w,c*a._data.intervalPx.y,w,{textAlign:"right"}));if(a._configCheckBox("ticks","xlab"))for(var b,c=0;c<a._data.nbTicks.x;c++)b=p((a._data.realMin.x+c*a._data.intervalVal.x)/a._data.intervalFactor.x,2).toString(),a.tickLabels.push(a._addText(b,c*a._data.intervalPx.x,0,1.1*w,{textAlign:"right"}))},_drawGraphTitle:function(){var a=this;a._reinitObject3DArray("graphTitle");var b=a.module.getConfiguration("labels"),c=a._meta.title||"";if(c&&""!==c)switch(b){case"none":return;default:a.graphTitle.push(a._addText(c,w/10,1.3*w,100,{textAlign:"left"}));}},_drawAxisLabels:function(){function a(a,b,c){var d=[];d.push(`X: ${a}`),d.push(`Y: ${b}`),d.push(`Z: ${c}`),$("#legend_titles").html(d.join("<br/>"))}function b(a,b,d){e.tickLabels.push(e._addText(c(a,"x"),w/2,0,1.4*w,{textAlign:"right"})),e.tickLabels.push(e._addText(c(b,"y"),-.4*w,w/2,w,{textAlign:"right"})),e.tickLabels.push(e._addText(c(d,"z"),1.4*w,0,w/2,{textAlign:"left"}))}function c(a,b){return 1===e._data.intervalFactor[b]?a:1<e._data.intervalFactor[b]?`${a} (\u00D7 10${d(Math.round(Math.log(e._data.intervalFactor[b])/Math.LN10))})`:`${a} (\u00D7 10${d(`-${-Math.round(Math.log(e._data.intervalFactor[b])/Math.LN10)}`)})`}function d(a){a=a.toString();for(var b="",c=0;c<a.length;c++)"2"===a[c]||"3"===a[c]?b+=String.fromCharCode(176+parseInt(a[c],10)):"0"<=a[c]&&"9">a[c]?b+=String.fromCharCode(8304+parseInt(a[c],10)):"-"===a[c]&&(b+=String.fromCharCode(8315));return b}var e=this;e._reinitObject3DArray("axisLabels");var f=e.module.getConfiguration("labels"),g=e._meta.getChildSync(["axis",e._data.xAxis||0,"label"]),h=e._meta.getChildSync(["axis",e._data.yAxis||1,"label"]),i=e._meta.getChildSync(["axis",e._data.zAxis||2,"label"]),j=e._meta.getChildSync(["axis",0,"unit"]),k=e._meta.getChildSync(["axis",1,"unit"]),l=e._meta.getChildSync(["axis",2,"unit"]);g=g&&g.get(),h=h&&h.get(),i=i&&i.get(),g=j&&`${g} [${j.get()}]`||g,h=k&&`${h} [${k.get()}]`||h,i=l&&`${i} [${l.get()}]`||i;var m=this.module.getConfiguration("xLabel")||g||"X",n=this.module.getConfiguration("yLabel")||h||"Y",o=this.module.getConfiguration("zLabel")||i||"Z",p=$("#legend_titles");switch(f){case"axis":b(m,n,o),p.hide();break;case"alegend":b("X","Y","Z"),a(m,n,o),p.show();break;case"both":b(m,n,o),a(m,n,o),p.show();break;default:}},_drawFaces:function(){var a=this;if(a._data){a._reinitObject3DArray("faces");var b,c,d,e=new k.PlaneBufferGeometry(w,w),f=new k.PlaneBufferGeometry(w,w),g=new k.PlaneBufferGeometry(w,w),h=new k.PlaneBufferGeometry(w,w),j=new k.PlaneBufferGeometry(w,w),l=new k.PlaneBufferGeometry(w,w),m=new k.MeshBasicMaterial({color:16777215,side:k.DoubleSide,transparent:!0,opacity:.6}),n=new k.Mesh(e,m),o=new k.Mesh(f,m),p=new k.Mesh(g,m),q=new k.Mesh(h,m),r=new k.Mesh(j,m),s=new k.Mesh(l,m);b=new k.Matrix4,c=new k.Matrix4,b.makeTranslation(w/2,w/2,a.gorigin.z),c.makeTranslation(0,0,w/2),n.applyMatrix(b),c.multiplyMatrices(b,c),q.applyMatrix(c),b=new k.Matrix4,c=new k.Matrix4,d=new k.Matrix4,b.makeRotationY(Math.PI/2),c.makeTranslation(-w/2,w/2,a.gorigin.x),c.multiplyMatrices(b,c),d.makeTranslation(0,0,w),o.applyMatrix(c),d.multiplyMatrices(c,d),r.applyMatrix(d),b=new k.Matrix4,c=new k.Matrix4,d=new k.Matrix4,b.makeRotationX(Math.PI/2),c.makeTranslation(w/2,w/2,-a.gorigin.y),c.multiplyMatrices(b,c),p.applyMatrix(c),d.makeTranslation(0,0,-w),d.multiplyMatrices(c,d),s.applyMatrix(d),q.visible=!1,r.visible=!1,s.visible=!1,a.faces.push(n),a.faces.push(o),a.faces.push(p);for(var t=0;t<a.faces.length;t++)a.scene.add(a.faces[t])}},_inBoundary:function(a){var b=this;return h.isObject(a)?!(a.x<b._data.realMin.x||a.x>b._data.realMax.x)&&!(a.y<b._data.realMin.y||a.y>b._data.realMax.y)&&!(a.z<b._data.realMin.z||a.z>b._data.realMax.z):!!h.isArray(a)&&b._inBoundary({x:a[0],y:a[1],z:a[2]})},_computeInBoundaryIndexes:function(){var a=this;a._data.inBoundary=[];for(var b=0;b<a._data.x.length;b++)a._inBoundary({x:a._data.x[b],y:a._data.y[b],z:a._data.z[b]})?a._data.inBoundary.push(!0):a._data.inBoundary.push(!1)},_mathPoints:function(){var a=this;if(a._data){a.mathPoints=[];for(var b=0;b<a._data.x.length;b++)if(a._data.inBoundary[b]){var c=A;a._data.size&&a._data.size[b]&&(c=a._data.size[b]);var d=new k.Sphere(new k.Vector3(a._data.normalizedData.x[b],a._data.normalizedData.y[b],a._data.normalizedData.z[b]),c*w);d.index=b,a.mathPoints.push(d)}}},_updateMathPoints:function(a){var b,c=this;if(a.applyFilter){b=c._data.inBoundary.slice(0);for(var d=0;d<c._dispFilter.length;d++)b[d]=c._dispFilter[d]&&b[d]}else b=c._data.inBoundary;for(var d=0;d<c._data.x.length;d++)c.mathPoints[d].radius=b[d]?c._data.size[d]*w:0},_zoomToFit:function(){var a=this,b=Math.PI/3,c=Math.PI/4,d=this._polarToCartesian(b,c,w*3),e=new k.Vector3(w/2,w/2,w/2);a.camera.position.set(d[0],d[1],d[2]),a.camera.lookAt(e),a.cameraLeft.position.set(d[0],d[1],d[2]),a.cameraLeft.lookAt(e),a.cameraRight.position.set(d[0],d[1],d[2]),a.cameraRight.lookAt(e)},_polarToCartesian:function(a,b,c){var d=Math.sin(b)*Math.cos(a)*c,e=Math.sin(b)*Math.sin(a)*c,f=Math.cos(b)*c;return[d,e,f]},init:function(){var a=this,b=this.module.getConfiguration("defaultPointColor");z=o(b[0],b[1],b[2]),this.dom||(this._id=e.getNextUniqueId(),this.dom=$(` <div id="${this._id}"></div>`).css({height:"100%",width:"100%",overflow:"hidden"}),this.dom.on("dblclick",function(){a.controls.reset(),a._zoomToFit()}),this.module.getDomContent().html(this.dom)),this.loadedData=$.Deferred(),this.resolveReady()},onResize:function(){var a=this;this.loadedData.done(function(){a._firstLoad?(a._initThreejs(),a._activateHighlights(),a._zoomToFit(),a._firstLoad=!1):(a.camera.aspect=a.width/a.height,a.camera.updateProjectionMatrix(),a.renderer.setSize(a.width,a.height),a._setBackgroundColor(),a.controls.handleResize(),a._render(),a.headlight&&(a.headlight.position.x=a.camera.position.x+200,a.headlight.position.y=a.camera.position.y+200,a.headlight.position.z=a.camera.position.z+200),a.tickLabels&&(a._drawTickLabels(),a._drawAxisLabels(),a._drawGraphTitle())),a._data&&(a._drawGraph(),a._drawColorBar())})},_setBackgroundColor:function(){var a=this.module.getConfiguration("backgroundColor");y=o(a[0],a[1],a[2]),this.renderer.setClearColor(y,1)},_newParticleObject:function(a,b){var c=this;b=b||{};var d=G[b.shape]||G[B];b.transparent&&(d=d.replace(/\.(png|svg|jpeg|jpg|gif)$/i,"t.$1"));var e={amplitude:{type:"f",value:1},color:{type:"c",value:new k.Color("#ffffff")},texture:{type:"t",value:k.ImageUtils.loadTexture(d)}},f=new k.ShaderMaterial({uniforms:e,attributes:{size:{type:"f",value:[]},ca:{type:"c",value:[]}},vertexShader:"      attribute float size;      attribute vec4 ca;      varying vec4 vColor;      void main() {        vColor = ca;        vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );        gl_PointSize = size * ( 1.0 / length( mvPosition.xyz ) );        gl_Position = projectionMatrix * mvPosition;      }",fragmentShader:"uniform vec3 color;      uniform sampler2D texture;      varying vec4 vColor;      void main() {        vec4 outColor = texture2D( texture, gl_PointCoord );        if ( outColor.a < 0.5 ) discard;        gl_FragColor = outColor * vec4( color * vColor.xyz, 1.0 );        float depth = gl_FragCoord.z / gl_FragCoord.w;        const vec3 fogColor = vec3( 0.0 );        float fogFactor = smoothstep( 0.0, 10000.0, depth );        gl_FragColor = mix( gl_FragColor, vec4( fogColor, gl_FragColor.w ), fogFactor );      }",transparent:!0}),g=new k.Geometry;if(a)for(var h,j=0;j<a.length;j++)h=new k.Vector3,h.x=c._data.normalizedData.x[a[j]],h.y=c._data.normalizedData.y[a[j]],h.z=c._data.normalizedData.z[a[j]],g.vertices.push(h);else for(var h,j=0;j<c._data.normalizedData.x.length;j++)h=new k.Vector3,h.x=c._data.normalizedData.x[j],h.y=c._data.normalizedData.y[j],h.z=c._data.normalizedData.z[j],g.vertices.push(h);var l=new k.PointCloud(g,f);return l.indexes=a,l},_updateParticleObject:function(a,b){if(a){var c=this;b=b||{};var d,e=a.indexes,f=a.geometry.vertices,g=a.material.attributes.size.value,h=a.material.attributes.ca.value,j=c._data.color,l=c._data.size,m=2.2388*(b.sizeFactor||1)*w*c.height,n=b.forcedColor?new k.Color(b.forcedColor):null,o=b.updateColor||!0;if(b.applyFilter){d=c._data.inBoundary.slice(0);for(var p=0;p<c._dispFilter.length;p++)d[p]=c._dispFilter[p]&&d[p]}else d=c._data.inBoundary;if(e)for(var q=0;q<f.length;q++)g[q]=d[e[q]]?(l[e[q]]||A)*m:-1,n?h[q]=n:o&&(h[q]=new k.Color(j[e[q]]||z));else for(var q=0;q<f.length;q++)g[q]=d[q]?(l[q]||A)*m:0,n?h[q]=n:o&&(h[q]=new k.Color(j[q]||z));a.material.attributes.size.needsUpdate=!0,a.material.attributes.ca.needsUpdate=!0}},_prepareHighlights:function(a){var b=this;b._highlightParticleObjects={};for(var c={},d=0;d<a.length;d++)c[b._data.shape[d]]=c[b._data.shape[d]]||{},c[b._data.shape[d]][a[d]]=c[b._data.shape[d]][a[d]]||[],c[b._data.shape[d]][a[d]].push(d);for(var e in c)for(var f in c[e])b._highlightParticleObjects[e]=b._highlightParticleObjects[e]||{},b._highlightParticleObjects[e][f]=b._newParticleObject(c[e][f],{shape:e||B,transparent:!0});b._doRender()},blank:{chart:r,data3D:r},update:{chart:function(a){return this._3d=this.module.getConfiguration("3d"),this.module.data=a,a.get()?void(this._convertChartToData(a.get()),this._completeChartData(),this._computeMinMax(),this._computeTickInfo(),this._computeInBoundaryIndexes(),this._normalizeData(),this._processColors(),this._setGridOrigin(),!this._firstLoad&&this._activateHighlights(),"pending"===this.loadedData.state()?this.loadedData.resolve():this._drawGraph()):void l.error("Unvalid value",a)},data3D:function(a){return this._3d=this.module.getConfiguration("3d"),this.module.data=a,a&&a.get()?void(this._convertData3dToData(a),this._completeChartData(),this._computeMinMax(),this._computeTickInfo(),this._computeInBoundaryIndexes(),this._normalizeData(),this._processColors(),this._setGridOrigin(),!this._firstLoad&&this._activateHighlights(),"pending"===this.loadedData.state()?this.loadedData.resolve():this._drawGraph()):void l.error(`Invalid value${a}`)},boolArray:function(a){if(this._data&&this._mainParticleObjects){var b=this;if(!a||!a.get())return void l.error("Unvalid value boolArray",a);for(var c in b._dispFilter=a.get(),b._mainParticleObjects)b._updateParticleObject(b._mainParticleObjects[c],{applyFilter:!0,updateColor:!1});for(var c in b._updateMathPoints({applyFilter:!0}),b._highlightParticleObjects)for(var d in b._highlightParticleObjects[c])b._updateParticleObject(b._highlightParticleObjects[c][d],{applyFilter:!0,updateColor:!1,sizeFactor:1.35});b._doRender()}}},_render:function(){var a=this;setTimeout(function(){a._doRender()},20)},_doRender:function(){if("sideBySide"===this._3d){var a=this.width/2,b=this.height;this.renderer.setViewport(0,0,a,b),this.renderer.setScissor(0,0,a,b),this.renderer.enableScissorTest(!0),this.cameraLeft.aspect=2*a/b,this.cameraLeft.updateProjectionMatrix(),this.renderer.render(this.scene,this.cameraLeft),this.renderer.setViewport(a,0,a,b),this.renderer.setScissor(a,0,a,b),this.renderer.enableScissorTest(!0),this.cameraRight.aspect=2*a/b,this.cameraRight.updateProjectionMatrix(),this.renderer.render(this.scene,this.cameraRight),this.renderer.setViewport(2*a,b,0,0),this.renderer.setScissor(2*a,b,0,0),this.renderer.enableScissorTest(!0)}this.renderer.render(this.scene,this.camera)},_convertData3dToData:function(a){function c(a){return h.isObject(a)||h.isArray(a)?null:a}function d(a,b,d){var e=a.getChildSync(b);return void 0===e?d:c(e.get())}var e=this;Array.isArray(a)&&0!==a.length||l.error("Data 3D not valid"),e._data=new DataObject;var f=e.module.getConfiguration("dataJpaths");e._data.x=[],e._data.y=[],e._data.z=[],e._data.size=[],e._data.color=[],e._data.shape=[],e._data._highlight=[];var g=h.cloneDeep(b.resurrect(f));h.each(g,a=>a.unshift(0));for(let b=0;b<a.length;b++)h.each(g,a=>a[0]=b),e._data.x.push(d(a,g.x,0)),e._data.y.push(d(a,g.y,0)),e._data.z.push(d(a,g.z,0)),e._data.color.push(d(a,g.color,z)),e._data.size.push(d(a,g.size,A)),e._data.shape.push(d(a,g.shape,B));e._meta=new DataObject,e._data.x=e._data.x||[],e._data.y=e._data.y||[],e._data.z=e._data.z||[],e._data.info=h.map(a,"info"),e._data._highlight=h.map(a,"_highlight"),h.some(e._data._highlight)||(e._data._highlight=[]),e._dispFilter=e._dispFilter||[]},_convertChartToData:function(a){this._data=new DataObject,this._meta=new DataObject;var b=this;if(Array.isArray(a.data)&&a.data[0]&&Array.isArray(a.data[0].y)){1<a.data.length&&l.warn("Scatter 3D module will merge series together");for(let c=0;c<a.data.length;c++)h.keys(a.data[c]).forEach(function(d){Array.isArray(a.data[c][d])?(b._data[d]=b._data[d]||[],b._data[d].push(a.data[c][d]),b._data[d]=h.flatten(b._data[d],!0)):b._data[d]=a.data[c][d],h.filter(b._data[d],function(a){return void 0!==a})});this._meta.axis=a.axis,this._data._highlight=this._data._highlight||[],h.keys(a).forEach(function(c){"data"!==c&&(b._meta[c]=a[c])}),b._dispFilter=b._dispFilter||[]}},_completeData:function(a,b){var c=this;c._data[a]=c._data[a]||[];for(var d=0;d<c._data.x.length;d++)void 0===c._data[a][d]&&(c._data[a][d]=b)},_completeChartData:function(){this._completeData("size",A),this._completeData("color",z),this._completeData("shape",B)},_activateHighlights:function(){function a(a){var b=!1;for(var d in c._highlightParticleObjects)c._highlightParticleObjects[d][a]&&c._highlightParticleObjects[d][a].drawn&&(c.scene.remove(c._highlightParticleObjects[d][a]),c._highlightParticleObjects[d][a].drawn=!1,b=!0);b&&c._render()}function b(a){for(var b in c._highlightParticleObjects)if(c._highlightParticleObjects[b][a]){if(!0===c._highlightParticleObjects[b][a].drawn)return;c.scene.add(c._highlightParticleObjects[b][a]),c._highlightParticleObjects[b][a].drawn=!0,c._updateParticleObject(c._highlightParticleObjects[b][a],{updateColor:!0,sizeFactor:1.35,transparent:!0}),c._render()}}var c=this;c._data&&(d.killHighlight(c.module.getId()),c._data._highlight&&function(e){c._prepareHighlights(e);var f=h.uniq(e);h.keys(f).forEach(function(c){f[c]&&d.listenHighlight({_highlight:f[c]},function(c,d){c?b(d):a(d)})})}(c._data._highlight))},updateOptions:function(){this._options={grid:{clickable:!0,hoverable:!0},series:{pie:{show:!0}}}}}),q});

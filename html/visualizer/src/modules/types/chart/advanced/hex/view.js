'use strict';require.config({paths:{"d3-plugins":"components/d3-plugins"},shim:{"d3-plugins":"d3"}}),define(["modules/default/defaultview","lodash","src/util/debug","src/util/util","d3","src/util/color","src/util/colorbar","src/util/ui","d3-plugins/hexbin/hexbin"],function(a,b,c,d,e,f,g,h){"use strict";function i(){}function j(a){try{a.data[0].x}catch(a){return c.warn("no chart data"),[]}for(var b=[],d=void 0!==a.data[0].z,e=0;e<a.data.length;e++)for(var f,g=0;g<a.data[e].x.length;g++)f=[a.data[e].x[g],a.data[e].y[g]],d&&f.push(a.data[e].z[g]),b.push(f);return b}function k(a){return void 0!==a&&3===a.length&&0===a[0]+a[1]+a[2]}function l(a){for(var b=[],c=0;c<a.length;c++){var d=a[c],e=Math.min.apply(null,d),f=Math.max.apply(null,d);if(0!==e||3!==d.length){b.push(void 0);continue}var g=d.indexOf(e),h=d.indexOf(f),j=2*(g+h)%3,k=[0,0,0];k=n(k,t(d,g,j,h)),k=n(k,s(d,g,j,h)),b.push(k)}return b}function m(a){for(var b=Array(a.length),c=0;c<a.length;c++)if(k(a[c])){var d=a[c][2],e=a[c][0];b[c]=[e+(d-(1&d))/2,d]}return b}function n(a,b){if(a.length!==b.length)throw new Error("Array not the same size in addition");for(var c=a.slice(0),d=0;d<a.length;d++)c[d]+=b[d];return c}function o(a,b){for(var c=a.slice(0),d=0;d<a.length;d++)c[d]*=b;return c}function p(a,b){for(var c=a.slice(0),d=0;d<a.length;d++)c[d]+=b;return c}function q(a,b){for(var c=Array(b),d=0;d<c.length;d++)c[d]=a;return c}function s(a,b,c,d){return b===c?[0,0,0]:0===c&&1===d||1===c&&0===d?o([1,-1,0],a[c]):1===c&&2===d||2===c&&1===d?o([0,1,-1],a[c]):o([-1,0,1],a[c])}function t(a,b,c,d){return c===d?[0,0,0]:0===d?o([0,-1,1],a[d]-a[c]):1===d?o([1,0,-1],a[d]-a[c]):o([-1,1,0],a[d]-a[c])}function u(c,a){for(var b=0,d=0;d<c.length;d++)c[d]===a[d]&&c[d]>b&&(b=c[d]);return b}function v(a){return[{x:a*Math.cos(-Math.PI/3),y:a*Math.sin(Math.PI/3)},{x:a*Math.cos(2*Math.PI/3),y:a*Math.sin(2*-Math.PI/3)},{x:a*Math.cos(Math.PI/3),y:a*Math.sin(-Math.PI/3)},{x:a*Math.cos(2*-Math.PI/3),y:a*Math.sin(2*Math.PI/3)},{x:a*Math.cos(Math.PI),y:a*Math.sin(Math.PI)},{x:a*Math.cos(0),y:a*Math.sin(0)}]}return i.prototype=$.extend(!0,{},a,{init:function(){},inDom:function(){this.id=d.getNextUniqueId(),this.dom=h.getSafeElement("div").attr("id",this.id),this.module.getDomContent().html(this.dom),this.resolveReady()},blank:{chart:function(){this.reset()}},update:{chart:function(a){this.ignored=[],this.chart=a.get();var b=j(this.chart);switch(this.originalData=b,this.coordinateSystem=this.module.getConfiguration("coordinateSystem"),this.axesType=this.module.getConfiguration("axesType"),this.layout="vertical",this.coordinateSystem){case"combinatorial":this.origin=[this.module.getConfiguration("originX"),this.module.getConfiguration("originY"),this.module.getConfiguration("originZ")],this.data=b,this._substractOrigin(),this._combinatorialBoundaries(this.data),this.data=l(this.data),this.cubicData=this.data,this.data=m(this.data);break;default:this.data=b;}this._chartData(),this._ignored(),this._normalize(),this._processColors(),this.draw()}},_substractOrigin:function(){for(var a=0;a<this.data.length;a++)this.data[a]=n(this.data[a],o(this.origin,-1))},_combinatorialBoundaries:function(){var a=b.map(this.originalData,0),c=b.map(this.originalData,1),d=b.map(this.originalData,2);this.combXmin=Math.min.apply(null,a),this.combYmin=Math.min.apply(null,c),this.combZmin=Math.min.apply(null,d),this.combXmax=Math.max.apply(null,a),this.combYmax=Math.max.apply(null,c),this.combZmax=Math.max.apply(null,d),this.combXYmax=u(a,c),this.combXZmax=u(a,d),this.combYZmax=u(c,d)},_reMinMax:function(a){this.minX=Math.min(this.minX,Math.min.apply(null,b.map(a,0))),this.minY=Math.min(this.minY,Math.min.apply(null,b.map(a,1))),this.maxX=Math.max(this.maxX,Math.max.apply(null,b.map(a,0))),this.maxY=Math.max(this.maxX,Math.max.apply(null,b.map(a,1))),this.lenX=this.maxX-this.minX,this.lenY=this.maxY-this.minY},_normalize:function(){var a=b.map(this.data,0),c=b.map(this.data,1),d=Math.min.apply(null,a),e=Math.min.apply(null,c),f=Math.max.apply(null,a),g=Math.max.apply(null,c);this.lenX=f-d,this.lenY=g-e;var h=Math.min(d,e);0!=h%2&&--h,this.normConstant=-h;for(var j=0;j<this.data.length;j++)this.data[j][0]+=this.normConstant,this.data[j][1]+=this.normConstant;this.minX=d+this.normConstant,this.minY=e+this.normConstant,this.maxX=f+this.normConstant,this.maxY=g+this.normConstant},_ignored:function(){for(var a=[],c=0;c<this.data.length;c++)void 0===this.data[c]&&a.push(c);this.totalSize=this.data.length,this.realSize=this.data.length-a.length,b.pullAt(this.data,a),b.pullAt(this.color,a),b.pullAt(this.cubicData,a),b.pullAt(this.originalData,a),b.pullAt(this.label,a)},_processColors:function(){var a=this.module.getConfiguration("gradient"),d=this.module.getConfiguration("stopType");a=b.filter(a,a=>void 0!==a.stopPosition),this.stopPositions=b.map(a,"stopPosition"),"percent"===d?(this.colorDomain=b.filter(this.color,a=>!isNaN(a)),this.colorDomain=[Math.min.apply(null,this.colorDomain),Math.max.apply(null,this.colorDomain)]):this.colorDomain=[Math.min.apply(null,this.stopPositions),Math.max.apply(null,this.stopPositions)],this.stopColors=b(a).map("color").map(f.getColor).value(),this.numberToColor=g.getColorScale({stops:this.stopColors,stopPositions:this.stopPositions,domain:this.colorDomain,stopType:d});for(var e=0;e<this.color.length;e++)if(!isNaN(this.color[e])){var h=this.numberToColor(this.color[e]);this.color[e]=h.color,this.opacity[e]=h.opacity}this.color=this.color.map(function(a){return void 0===a?"lightblue":a}),this.opacity=this.opacity.map(function(a){return void 0===a?1:a})},_fontSize:function(a){function b(b){var c=b.split("\n"),e=c.reduce(function(a,b){return Math.max(a,b.length)},0);return e=Math.max(e,c.length),e?2*(a/e):d}var c,d=50;return(c=this.module.getConfiguration("fontSize"))||(c=this.label.reduce(function(a,c){return c?Math.min(a,b(c)):a},d)),`${0|c}px`},_chartData:function(){this.color=[],this.label=[],this.opacity=[];for(var a,c=0;c<this.chart.data.length;c++)a=this.chart.data[c],this.color.push(b.map(a.info,"color")),this.label.push(b.map(a.info,"label")),this.opacity.push(b.map(a.info,"opacity"));this.color=b.flatten(this.color),this.label=b.flatten(this.label),this.opacity=b.flatten(this.opacity),this.chart.axis&&(this.axes=this.chart.axis)},onResize:function(){this.redraw()},draw:function(){if("combinatorial"===this.coordinateSystem&&this.axes&&"none"!==this.axesType){this.axeData={};var a=3;this.axeData.points=[[this.combXmax+a,0,0],[0,this.combYZmax+a,this.combYZmax+a],[0,this.combYmax+a,0],[this.combXZmax+a,0,this.combXZmax+a],[0,0,this.combZmax+a],[this.combXYmax+a,this.combXYmax+a,0]];var b=1,c=2;this.axeData.startPoints=[[this.combXmax+b,0,0],[0,this.combYZmax+b,this.combYZmax+b],[0,this.combYmax+b,0],[this.combXZmax+b,0,this.combXZmax+b],[0,0,this.combZmax+b],[this.combXYmax+b,this.combXYmax+b,0]],this.axeData.endPoints=[[this.combXmax+c,0,0],[0,this.combYZmax+c,this.combYZmax+c],[0,this.combYmax+c,0],[this.combXZmax+c,0,this.combXZmax+c],[0,0,this.combZmax+c],[this.combXYmax+c,this.combXYmax+c,0]],this.axeLabels=[this.axes[0].name,this.axes[1].name+this.axes[2].name,this.axes[1].name,this.axes[0].name+this.axes[2].name,this.axes[2].name,this.axes[0].name+this.axes[1].name],this.axeData.points=l(this.axeData.points),this.axeData.points=m(this.axeData.points),this.axeData.startPoints=l(this.axeData.startPoints),this.axeData.startPoints=m(this.axeData.startPoints),this.axeData.endPoints=l(this.axeData.endPoints),this.axeData.endPoints=m(this.axeData.endPoints);for(var d=0;d<this.axeData.points.length;d++)this.axeData.points[d]=p(this.axeData.points[d],this.normConstant),this.axeData.startPoints[d]=p(this.axeData.startPoints[d],this.normConstant),this.axeData.endPoints[d]=p(this.axeData.endPoints[d],this.normConstant);this._reMinMax(this.axeData.points)}this.redraw()},redraw:function(){function a(a){return[1.75*(a[0]*j),1.5*(a[1]*j)]}function c(){r.attr("transform",`translate(${e.event.translate})scale(${e.event.scale})`)}if(this.data&&0!==this.data.length){var f=this;this.reset();for(var h=this.dom.width()/(2+1.5*this.lenX),d=this.dom.height()/(1.75*(this.lenX+1)),j=Math.min(h,d),k=[],l=0;l<this.data.length;l++)k.push(a(this.data[l]));var m=b.flatten([a([this.minX-.3,this.minY-.8]),a([this.lenX+1.5,this.lenY+1.5])]);this.module.getConfigurationCheckbox("showColorBar","show")&&(m[0]-=100,m[2]+=100);var n=this.width,o=this.height,p=e.select(`#${this.id}`).append("svg").attr("viewBox",m.join(",")).attr("width",n).attr("height",o).style("display","block"),r=p.append("g"),s=this.module.getConfiguration("tickMode"),t=this.module.getConfiguration("tickNumber"),u=(this.module.getConfiguration("tickValues")||"").split(",").map(function(a){return+a});if(this.module.getConfigurationCheckbox("showColorBar","show")){var w=m[0],x=m[1],y=g.getSvg({width:50,height:.95*m[3]-20,axis:{orientation:"left",ticks:"auto"===s?t:void 0,tickValues:"manual"===s?u:void 0,order:"asc"},stops:this.stopColors,stopPositions:this.stopPositions,domain:this.colorDomain,stopType:this.module.getConfiguration("stopType")});y=`<g transform="translate(${w},${x})">${y}</g>`,r.html(y)}var z=e.hexbin().radius(j),A=f._fontSize(j);if("combinatorial"===this.coordinateSystem&&this.axes)if(r.append("defs").selectAll("marker").data(["normal"]).enter().append("marker").attr("id",function(a){return a}).attr("viewBox","0 -5 10 10").attr("refX",10).attr("refY",0).attr("markerWidth",10).attr("markerHeight",10).attr("orient","auto").append("path").attr("d","M0,-4L10,0L0,4"),"graph"===this.axesType){var B=[],C=[],D=[];for(l=0;l<this.axeData.points.length;l++)B.push(a(this.axeData.points[l])),C.push(a(this.axeData.startPoints[l])),D.push(a(this.axeData.endPoints[l]));C=z(C),D=z(D),B=z(B),r.append("g").selectAll(".axes").data(B).enter().append("foreignObject").style("pointer-events","none").attr({width:j,height:j}).attr("transform",function(a){return`translate(${a.x-j/2},${a.y-j/2})`}).append("xhtml:div").append("div").style({display:"flex",height:`${j}px`,width:`${j}px`,"box-sizing":"border-box","align-items":"center","font-size":A}).attr("class","axe-text").html(function(a,b){return f.axeLabels[b]}),r.append("g").selectAll(".axe-arrow").data(B).enter().append("path").attr("class","axe-arrow").attr("marker-end","url(#normal)").attr("d",function(a,b){return`M${C[b].x},${C[b].y}L${D[b].x} ${D[b].y}`})}else if("legend"===this.axesType){var E=30,F=v(E),G=v(20),H=q({x:0,y:0},6),I=20;r.append("g").attr("class","abcd").selectAll(".axes-legend").data(F).enter().append("foreignObject").style("pointer-events","none").attr({width:I,height:I}).attr("transform",function(a){return`translate(${a.x-m[0]-I/2},${a.y+m[1]+E-I/2})`}).append("xhtml:div").append("div").style({display:"flex",height:`${j}px`,width:`${j}px`,"box-sizing":"border-box","font-size":16,"align-items":"center"}).attr("class","axe-corner-text").html(function(a,b){return f.axeLabels[b]}),r.append("g").selectAll(".axe-arrow-legend").data(H).enter().append("path").attr("class","axe-arrow-legend").attr("marker-end","url(#normal)").attr("d",function(a,b){return`M${H[b].x-m[0]-4},${H[b].y+m[1]+E}L${G[b].x-m[0]-4} ${G[b].y+m[1]+E}`})}var J=z(k);r.append("g").selectAll(".hexagon").data(J).enter().append("path").attr("class","hexagon").attr("d",function(a){return`M${a.x},${a.y}${z.hexagon()}`}).attr("stroke","black").attr("stroke-width","1px").style("fill",function(a,b){return f.color[b]}).style("fill-opacity",function(a,b){return f.opacity[b]});var K=r.append("g").selectAll("foreignObject").data(J).enter().append("foreignObject").style("pointer-events","none").attr({width:j,height:j,transform:function(a){return`translate(${a.x-j/2},${a.y-j/2})`}});if(K.append("xhtml:div").append("div").style({display:"flex",height:`${j}px`,width:`${j}px`,padding:0,"align-items":"center","justify-content":"center","box-sizing":"border-box","font-size":A}).html(function(a,b){return f.label[b]}),this.module.getConfigurationCheckbox("enableZoom","yes")){var L=e.behavior.zoom().scaleExtent([.2,10]).on("zoom",c);p.call(L).on("dblclick.zoom",function(){L.scale(1),L.translate([0,0]),L.event(p)})}}},reset:function(){this.dom.html("")}}),i});

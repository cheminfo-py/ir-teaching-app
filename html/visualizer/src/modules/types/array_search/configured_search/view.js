'use strict';define(["modules/default/defaultview","src/util/datatraversing","src/util/api","lib/formcreator/formcreator","src/util/util","src/util/debug"],function(Default,Traversing,API,FormCreator,Util,Debug){"use strict";function View(){}return $.extend(!0,View.prototype,Default,{init:function(){var a=this,b=$("<div>").css({position:"relative",height:"100%",weight:"100%"});this.overlay=$("<div>").css({position:"absolute",height:"100%",width:"100%",zIndex:1e3,backgroundColor:"rgba(200,200,200,0)",color:"rgba(50,50,50,0)",display:"none"}).appendTo(b).click(function(b){b.stopPropagation(),a.searchEnabled=!0,a.overlay.animate({backgroundColor:"rgba(200,200,200,0)",color:"rgba(50,50,50,0)"},500,function(){a.overlay.css("display","none")}),a.search()}).append($(`<div>${this.module.getConfiguration("disableMessage")}</div>`).css({textAlign:"center",width:"100%",zIndex:1001,display:"table-cell",verticalAlign:"middle",fontSize:"20pt"})),this.searchEnabled=!0,this.dom=$("<div>").appendTo(b),this.module.getDomContent().html(b),this.variables={},this.cfgValue={},this.maxhits=parseInt(this.module.getConfiguration("maxhits"),10)||Number.POSITIVE_INFINITY,this._jpathsFcts={};for(var c=this.module.getConfiguration("searchfields"),d=this.module.definition.vars_out||[],e=[],f=0,g=d.length,h={sections:{cfg:{groups:{cfg:{options:{type:"list"},fields:FormCreator.makeStructure(c,function(b){for(var c=0,d=b.groups.general[0].searchOnField.length;b.groups.general[0].searchOnField[c];c++)Util.addjPathFunction(a._jpathsFcts,b.groups.general[0].searchOnField[c])})}}}}};f<g;f++)e.push(d[f].name);var k=FormCreator.makeForm();k.init({onValueChanged:function(){var b=k.getValue().sections.cfg[0].groups.cfg[0],c={};for(var d in b)c[d]=b[d][0];$.extend(a.cfgValue,c),a.search()}}),k.setStructure(h),k.onStructureLoaded().done(function(){k.fill({})}),k.onLoaded().done(function(){a.dom.html(k.makeDom(2)),k.inDom(),k.fieldElementValueChanged()}),this.makeSearchFilter(),this.resolveReady()},blank:{value:function(){this.dom.empty()}},search:function(){if(this.searchEnabled){var a,b,c,d=this.cfgValue,e=new DataArray,f=new DataArray,g=Object.keys(this.variables);if(0===g.length||0===Object.keys(d).length)return;var h=this.maxhits,j=0;for(var k in g)for(c=this.variables[g[k]],b=c.length,a=0;a<b;a++)this.searchElement(d,c.getChildSync([a]).get())?(j<h&&(e[j++]=c[a]),f[a]=!0):f[a]=!1;this.module.controller.searchDone(e,f)}},_makeOp:function(a,b,c){b=`cfg[ "${b}" ]`;var d="",e="";c.number&&(d="parseFloat(",e=")");var f=".toLowerCase()";return c.caseSensitive&&(f=""),"="===a||"eq"===a?c.number?` el == ${d}${b}${e} `:` ((el+"")${f}) == ${b}${f} `:"<>"===a||"><"===a||"!="===a?` (el + "") !== ${b} `:">"===a?` el > ${d}${b}${e} `:">="===a?` el >= ${d}${b}${e} `:"<"===a?` el < ${d}${b}${e} `:"<="===a?` el <= ${d}${b}${e} `:"contains"===a?` el${f}.match(${b}${f}) `:"notcontain"===a?` ! el${f}.match(${b}${f}) `:"starts"===a?` el${f}.match(new RegExp("^"+${b}${f})) `:"end"===a?` el${f}.match(new RegExp(${b}${f}+"$")) `:"btw"===a?` ( el >= parseFloat( ${b}[0] ) && el <= parseFloat( ${b}[1] ) )`:void 0},makeSearchFilter:function(){var searchOn,searchfields=this.module.getConfiguration("searchfields"),i=0,l=searchfields.length,toEval="";for(toEval+=" this._searchFunc = function( cfg, row ) { ",toEval+=" var el; ",toEval+=" return ";i<l;i++){searchOn=searchfields[i].groups.general[0].searchOnField||[],0<i&&(toEval+=" && ");var j=0,k=searchOn.length;if(0<k){for(toEval+=" ( ";j<k;j++){0<j&&(toEval+=" || ");var opts={};"float"===searchfields[i].groups.general[0].type[0]&&(opts.number=!0),searchfields[i].groups.text&&"case_sensitive"===searchfields[i].groups.text[0].case_sensitive[0][0]&&(opts.caseSensitive=!0);var allow_undefined=!1;searchfields[i].groups.general[0].allow_undefined&&searchfields[i].groups.general[0].allow_undefined[0]&&(allow_undefined=!!searchfields[i].groups.general[0].allow_undefined[0].length),toEval+=` ( ( el = this.getJpath( "${searchOn[j]}", row ) ) ? ( `,toEval+=this._makeOp(searchfields[i].groups.general[0].operator[0],searchfields[i].groups.general[0].name[0],opts),toEval+=` ) : ${allow_undefined} ) `}toEval+=" ) "}}toEval+=";};";try{this._searchFunc=null,eval(toEval)}catch(a){Debug.error("Error while evaluating function.",toEval)}},searchElement:function(a,b){return this._searchFunc(a,b)},getJpath:function(a,b){return this._jpathsFcts[a](b)},update:{array:function(a,b){a&&(this.variables[b]=a.get(),this.search())}},onActionReceive:{disable:function(){this.searchEnabled&&(this.searchEnabled=!1,this.overlay.css("display","table"),this.overlay.animate({backgroundColor:"rgba(200,200,200,0.6)",color:"rgba(50,50,50,1)"},500))}}}),View});
